<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Par2 – Home + Editor + Stats/Trends</title>

<!-- ======== EDITOR (DARK) THEME ======== -->
<style>
  :root {
    --bg:#0f1115; --panel:#1a1f24; --panel-2:#11161b; --text:#e8ecf1;
    --muted:#9aa7b2; --accent:#2ea043; --accent-2:#3b82f6; --btn:#2b3138; --btn-active:#355043;
    --border:#2a3138; --radius:14px;
    --blue:#3b82f6; --green:#22c55e; --red:#ef4444; --purple:#a855f7;
  }

  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,Inter,Arial,sans-serif}
  .wrap{max-width:420px;margin:0 auto;padding:12px}

  header.editorbar{display:flex;gap:6px;padding:6px;border-bottom:1px solid var(--border);
    position:sticky;top:0;background:rgba(15,17,21,.95);backdrop-filter:blur(8px);z-index:4}
  .btn{background:var(--btn);color:var(--text);border:1px solid var(--border);
    padding:8px 12px;border-radius:10px;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center}
  .btn:focus{outline:2px solid #5a9; outline-offset:2px}
  .save{background:var(--accent);border:none;color:#08130a;font-weight:700}
  .btn.full{width:100%; justify-content:center}
  .btn.chartToggle{background:var(--accent-2); color:#fff; border:none; font-weight:800;
    padding:14px 18px; border-radius:14px; font-size:16px}
  .hidden{display:none}

  header.editorbar .btn[data-color]{border-color:transparent;color:#fff;font-weight:800}
  header.editorbar .btn[data-color="blue"]{background:var(--blue)}
  header.editorbar .btn[data-color="green"]{background:var(--green);color:#08210a}
  header.editorbar .btn[data-color="red"]{background:var(--red)}
  header.editorbar .btn[data-color="purple"]{background:var(--purple)}
  header.editorbar .btn[data-color]:hover{filter:brightness(1.06)}
  header.editorbar .btn[data-color]:active{transform:translateY(1px)}

  h1.sessionTitle{margin:4px 0 0;text-align:center;font-size:20px;font-weight:800}
  h2{margin:0 0 8px 0;font-size:14px;color:var(--muted);font-weight:600}
  .h2-center-white{color:var(--text); text-align:center;}

  /* helper toasts */
  .helpwrap{position:relative; display:flex; justify-content:center; align-items:center;}
  .helpbtn{cursor:help}
  .tip{position:absolute; top:100%; left:50%; transform:translateX(-50%);
    background:var(--panel-2); border:1px solid var(--border); color:var(--text);
    padding:10px 12px; border-radius:10px; font-size:13px; width:min(320px,90vw);
    margin-top:6px; display:none; z-index:5}
  .helpwrap.open .tip{ display:block; }

  .panel{background:var(--panel);padding:12px;margin:5px 0;border-radius:var(--radius);
    border:1px solid var(--border)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row.divider-2cols{grid-template-columns:minmax(0,1fr) 1px minmax(0,1fr);align-items:start}
  .vdiv{width:1px;background:var(--border);height:100%;border-radius:1px}
  .field{display:grid;gap:1px}

  .input,.counter,.pill{background:var(--panel-2);border:1px solid var(--border);border-radius:12px;
    padding:10px 12px;color:var(--text);display:inline-flex;align-items:center;justify-content:center}
  .input input{background:transparent;border:none;outline:none;color:var(--text);width:100%;font-size:16px}
  .input.slim{padding:8px 10px; min-width:84px}
  .input.datepill{height:64px; padding:8px 12px; border-radius:12px; width:100%}
  .input.slim.p1{padding:4px 10px; min-width:0; border-radius:10px; width:auto}
  .inlinePuttRow { display:flex; align-items:center; gap:8px; margin:4px 0 14px 0; justify-content:center; }
  .inlinePuttRow .p1 input{ width:5ch; text-align:center; font-variant-numeric:tabular-nums; }
  .counter{gap:8px}
  .counter button{width:36px;height:36px;background:var(--btn);color:var(--text);
    border:1px solid var(--border);border-radius:10px}

  .chips{display:flex;gap:10px;flex-wrap:wrap}
  .pill{padding:10px 12px;border-radius:14px;cursor:pointer; color:#9aa7b2; border-color:var(--border)}
  .pill.active{outline:2px solid var(--accent)}
  .pill[data-lie="Fairway"].active  { color:#7CFC00; border-color:#375b37; outline-color:#7CFC00 }
  .pill[data-lie="Rough"].active    { color:#ffa74d; border-color:#6f5131; outline-color:#ffa74d }
  .pill[data-lie="Sand"].active     { color:#e8d27c; border-color:#6a5b2e; outline-color:#e8d27c }
  .pill[data-lie="Recovery"].active { color:#ff5a5a; border-color:#633138; outline-color:#ff5a5a }

  #distanceGrid{display:grid;grid-template-columns:repeat(6,1fr);gap:6px}
  #distanceGrid button{background:var(--btn);color:var(--text);border:1px solid var(--border);
    padding:6px;border-radius:9px;min-height:34px;font-size:13px}
  #distanceGrid button.active{background:var(--btn-active);border-color:#3f6f5d;box-shadow:0 0 0 2px var(--accent) inset}

  .subtle{color:var(--muted);font-size:12px}
  .subNote{ font-size:11px; font-style:italic; opacity:.9; margin-left:4px; }

  .stepper { display:grid; grid-template-columns:36px minmax(0,1fr) 36px; gap:8px; align-items:center; }
  .stepper .step { width:36px; height:36px; background:var(--btn); border:1px solid var(--border); border-radius:10px; font-size:16px; display:flex; align-items:center; justify-content:center; cursor:pointer; }
  .stepper, .stepper * {
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
}
  .stepper .step {
  user-select: none;
  -webkit-user-select: none;
}
  .readout { display:flex; align-items:center; justify-content:center; gap:6px; font-weight:800; font-size:20px; }
  .readout input.readnum{ width:clamp(42px, 18vw, 70px); text-align:center; font-weight:800; font-size:20px; background:transparent; border:none; outline:none; color:var(--text); }
  .readout .unit { font-weight:600; font-size:14px; color:#fff; opacity:.9 }
  .modeTag { display:inline-block; text-align:center; border-radius:999px; padding:6px 10px; border:1px solid var(--border); background:var(--panel-2); font-weight:600; font-size:13px; color:#fff }

  .row.divider-2cols > .field{
    display:grid;
    grid-template-columns:36px minmax(0,1fr) 36px;
    grid-template-rows:auto auto auto;
    gap:6px 8px; align-items:center;
  }
  .microlabel{font-size:11px; color:var(--muted); justify-self:center; align-self:end}
  .ml-left { grid-column:1; grid-row:1; }
  .ml-right{ grid-column:3; grid-row:1; }
  .row.divider-2cols > .field > .stepper{grid-column:1 / -1;grid-row:2}
  .row.divider-2cols > .field > .modeTag{grid-column:2;grid-row:3;justify-self:center}

  .capHint{font-size:11px; color:var(--muted); text-align:center; opacity:0; transition:opacity .15s; height:0; overflow:hidden}
  .capHint.show{opacity:1; height:auto; margin-top:4px}

  .footer{display:grid;grid-template-columns:auto auto 1fr auto;gap:10px;align-items:center}
  .footer .save {padding:12px 18px; font-size:16px; border-radius:12px; min-width:130px;}
  .footer .scoreline{font-weight:600}
  .footer .undo {padding:8px 12px; font-size:13px; border-radius:10px; opacity:.95;}

  table{width:100%;border-collapse:collapse;font-size:12px}
  th,td{padding:10px 8px;border-bottom:1px solid var(--border);text-align:left;color:var(--text)}
  th{color:#fff;font-weight:600}
  .tight th,.tight td{padding:8px}
  .score-cell{white-space:nowrap}
  .rowbtn{background:var(--btn);border:1px solid var(--border);border-radius:6px;padding:0 4px;cursor:pointer;font-size:11px;line-height:1;margin-left:6px}

  .seg {display:inline-flex; border:1px solid var(--border); border-radius:10px; overflow:hidden}
  .seg button{background:var(--panel-2); color:var(--text); padding:6px 10px; border:none; cursor:pointer}
  .seg button.active{background:var(--btn-active)}
  canvas{display:block; width:100%; height:auto; max-width:380px; border-radius:10px; background:#101419}
  .filterbar { margin-top:8px; display:flex; gap:8px; flex-wrap:wrap }
  .flt { display:inline-flex; align-items:center; padding:4px 8px; border-radius:10px; border:1px solid var(--border); user-select:none; cursor:pointer; background:transparent; }
  .flt.off { filter: grayscale(1); opacity:.45; }
  .flt-fairway { color:#7CFC00; border-color:#375b37 }
  .flt-rough   { color:#ffa74d; border-color:#6f5131 }
  .flt-sand    { color:#e8d27c; border-color:#6a5b2e }
  .flt-recovery{ color:#ff5a5a; border-color:#633138 }
  .flt-d1 { color:#9cdcfe; border-color:#395268 }
  .flt-d2 { color:#a6e22e; border-color:#3b5b2b }
  .flt-d3 { color:#ffb454; border-color:#6a4c22 }

  #summaryBarTop{font-weight:700;font-size:14px;text-align:center}

  @media (max-width: 380px){
    .row.divider-2cols > .field{grid-template-columns:32px minmax(0,1fr) 32px;gap:6px}
    .stepper { grid-template-columns:32px minmax(0,1fr) 32px; gap:6px; }
    .stepper .step{ width:32px; height:32px }
    .readout input.readnum{ width:clamp(38px, 22vw, 56px); font-size:18px }
  }
</style>

<!-- ======== HOME + TRENDS (LIGHT) THEME – scoped ======== -->
<style>
  /* HOME / landing */
  #view-home{background:#fafaf7;color:#0b1220;min-height:100vh}
  #view-home .homewrap{max-width:520px;margin:0 auto;padding:24px 16px}
  #view-home .title{display:flex;align-items:center;gap:10px;font-weight:900;font-size:36px;letter-spacing:-.02em;margin:10px 0 4px}
  #view-home .subtitle{font-weight:700;color:#1f2937;margin:0 0 18px}
  #view-home .card{background:#fff;border:1px solid #e6ebf1;border-radius:18px;padding:18px}
  #view-home ul{margin:10px 0 0 0;padding-left:20px}
  #view-home li{margin:8px 0;font-weight:700;color:#0b1220}
  #homeTrendsBtn{ display:none !important; }
  #view-home .actions{
    display:flex;
    gap:10px;
    margin-top:16px;
    flex-wrap:wrap;
    justify-content:center; /* centers the Start Session button */
  }
  #view-home .btnL{appearance:none;border:1px solid #e6ebf1;background:#2563eb;color:#fff;
    padding:12px 16px;border-radius:12px;font-weight:800;cursor:pointer}
  #view-home .btnL.ghost{background:#fff;color:#0b1220}

  /* TRENDS light theme */
  #view-trends{background:#f7f9fc;color:#0b1220;min-height:100vh}
  #view-trends .twrap{max-width:420px; margin:0 auto; padding:14px}
  #view-trends .hdr{display:flex; align-items:center; gap:12px; padding:12px 14px}
  #view-trends .hdr .back{width:36px;height:36px;border-radius:999px;background:#eef2f7;border:1px solid #e6ebf1; display:flex;align-items:center;justify-content:center; font-size:20px; color:#111;}
  #view-trends .hdr h2{flex:1; text-align:center; margin:0; font-size:20px; font-weight:800}
  #view-trends .tools{display:flex; gap:6px}
  #view-trends .tbtn{appearance:none; border:1px solid #e6ebf1; background:#fff; color:#0b1220; padding:8px 10px; border-radius:10px; font-weight:700; cursor:pointer; text-decoration:none; font-size:13px}
  #view-trends .tbtn.primary{ background:#2563eb; color:#fff; border-color:transparent }
  #view-trends .tbtn.danger{ background:#ef4444; color:#fff; border-color:#ef4444 }

  #view-trends .pickRow{display:flex; gap:8px; align-items:center; padding:0 14px 8px}
  #view-trends select{flex:1; height:40px; border:1px solid #e6ebf1; border-radius:10px; padding:0 10px; background:#fff; font-weight:700}

  #view-trends .tseg{display:flex; gap:8px; background:#eef2f7; border:1px solid #e6ebf1; padding:8px; border-radius:999px; justify-content:center; position:sticky; top:0; z-index:5}
  #view-trends .tseg button{appearance:none; border:none; background:transparent; padding:10px 16px; border-radius:999px; font-weight:800; font-size:15px; color:#334155; cursor:pointer}
  #view-trends .tseg button.active{background:#fff; color:#2563eb; box-shadow:0 1px 2px rgba(0,0,0,.06)}

  #view-trends .kpis{display:grid; grid-template-columns:1fr 1fr; gap:14px; margin:14px 0}
  #view-trends .kpi{background:#fff; border:1px solid #e6ebf1; border-radius:16px; padding:14px}
  #view-trends .kpi .big{font-size:40px; font-weight:800; line-height:1; letter-spacing:-.02em}
  #view-trends .kpi .label{color:#6b7280; margin-top:6px; font-weight:600}
  #view-trends .chips{display:flex; gap:6px; flex-wrap:nowrap; overflow-x:auto; margin-bottom:12px}
  #view-trends .chip{padding:4px 8px; border:1px solid #e6ebf1; border-radius:999px; background:#f4f7fb; color:#334155; font-weight:700; cursor:pointer; font-size:12px; white-space:nowrap}
  #view-trends .chip.active{background:#fff; color:#0f172a; box-shadow:0 1px 2px rgba(0,0,0,.06)}
  #view-trends .card{background:#fff; border:1px solid #e6ebf1; border-radius:16px; overflow:hidden; margin-top:12px}
  #view-trends table{width:100%; border-collapse:separate; border-spacing:0}
  #view-trends th,#view-trends td{padding:14px 12px; text-align:left}
  #view-trends thead th{background:#f3f6fb; color:#1f2937; font-weight:800; font-size:14px}
  #view-trends tbody td{border-top:1px solid #e6ebf1; font-weight:700; color:#0b1220}
  #view-trends .right{text-align:right}
  #view-trends .notice{font-size:12px; color:#6b7280; margin-top:8px}
</style>
</head>

<body>
<!-- ========================= HOME / LANDING ========================= -->
<div id="view-home">
  <div class="homewrap">
    <div class="title">⛳ Par2<span style="font-weight:700">—</span></div>
    <div class="subtitle">The Short Game Challenge</div>
    <div class="card">
      <ul>
        <li>Every hole is a par 2</li>
        <li>Start with a chip from a set distance and lie</li>
        <li>Track where you leave it, then putt out</li>
        <li>The app logs your score, distance control, and dispersion</li>
      </ul>
      <div class="actions">
        <button class="btnL" id="startSessionBtn">Start Session</button>
        <button class="btnL.ghost btnL" id="homeTrendsBtn">View Stats/Trends</button>
      </div>
    </div>
  </div>
</div>

<!-- ========================= EDITOR ========================= -->
<div id="view-editor" class="hidden">
<header class="wrap editorbar">
  <button class="btn" data-color="green"  id="saveSessionBtn" title="Save current session to Stats/Trends">Finish Session</button>
  <button class="btn" data-color="red"    id="newSessionBtn" title="Start a fresh session">New Session</button>
  <button class="btn" data-color="purple" id="exportBtn">Export CSV</button>
  <button class="btn" data-color="blue"   id="goTrendsBtn" title="Open Stats/Trends">Stats/Trends</button>
</header>

  <section class="wrap"><h1 id="sessionHeader" class="sessionTitle">Session: —</h1></section>

  <!-- fixed: use an inner .panel so background aligns with the rest -->
  <section class="wrap">
    <div class="panel"><div id="summaryBarTop">Par: 0 | Gross: 0 | Up/Down: 0% | To Par: 0</div></div>
  </section>

  <main class="wrap" id="topOfApp">
    <section class="panel">
      <div class="row">
        <div class="field">
          <h2 class="h2-center-white">Hole</h2>
          <div class="counter">
            <button id="holeMinus">−</button>
            <div class="input"><input id="hole" type="number" min="1" value="1" inputmode="numeric" /></div>
            <button id="holePlus">+</button>
          </div>
        </div>
        <div class="field">
          <h2 class="h2-center-white">Date</h2>
          <div class="input datepill"><input id="date" type="date" /></div>
        </div>
      </div>
    </section>

    <section class="panel">
      <h2 class="h2-center-white">Chip Starting Distance (yds)</h2>
      <div id="distanceGrid">
        <button>10</button><button>15</button><button>20</button><button>25</button><button>30</button><button>35</button>
        <button>40</button><button>45</button><button>50</button><button>55</button><button>60</button><button>65</button>
      </div>
    </section>

    <section class="panel">
      <h2 class="h2-center-white">Lie</h2>
      <div class="chips" id="lieChips">
        <div class="pill" data-lie="Fairway">Fairway</div>
        <div class="pill" data-lie="Rough">Rough</div>
        <div class="pill" data-lie="Sand">Sand</div>
        <div class="pill" data-lie="Recovery">Recovery</div>
      </div>
    </section>

    <!-- Chip result -->
    <section class="panel hidden" id="chipSection">
      <h2 class="h2-center-white helpwrap" id="chipHelpWrap">
        <span class="helpbtn" id="chipHelpBtn">Input Chip Result <span class="subNote">(distance from hole)</span></span>
        <span class="tip" id="chipHelpTip">Enter how short/long and which side (L/R) the ball finished from the hole.</span>
      </h2>
      <div class="row divider-2cols">
        <div class="field">
          <div class="microlabel ml-left">Short</div>
          <div class="microlabel ml-right">Long</div>
          <div class="stepper">
            <button class="step" id="depthDown">▼</button>
            <div class="readout">
              <input id="depthInput" class="readnum" type="text" inputmode="text" pattern="-?\d{1,2}" maxlength="3" value="0" aria-label="Depth signed feet" />
              <span class="unit">ft</span>
            </div>
            <button class="step" id="depthUp">▲</button>
          </div>
          <div id="depthModeTag" class="modeTag">Exact</div>
          <div class="capHint" id="capHintDepthChip">Capped at ±99</div>
        </div>
        <div class="vdiv" aria-hidden="true"></div>
        <div class="field">
          <div class="microlabel ml-left">Left</div>
          <div class="microlabel ml-right">Right</div>
          <div class="stepper">
            <button class="step" id="lineLeft">◀</button>
            <div class="readout">
              <input id="lineInput" class="readnum" type="text" inputmode="text" pattern="-?\d{1,2}" maxlength="3" value="0" aria-label="Line signed feet" />
              <span class="unit">ft</span>
            </div>
            <button class="step" id="lineRight">▶</button>
          </div>
          <div id="lineModeTag" class="modeTag">Straight</div>
          <div class="capHint" id="capHintLineChip">Capped at ±99</div>
        </div>
      </div>
    </section>

    <!-- Putt 1 -->
    <section class="panel hidden" id="sectionP1">
      <h2 class="h2-center-white helpwrap" id="putt1HeaderWrap">
        <span class="helpbtn" id="putt1HeaderBtn">Putt 1</span>
        <span class="tip" id="putt1HeaderTip">Derived leave from chip: —</span>
      </h2>

      <div class="inlinePuttRow" aria-label="First putt distance">
        <div class="input slim p1"><input id="putt1Dist" type="number" min="0" step="1" placeholder="0" inputmode="numeric" /></div>
        <span class="unit">ft</span>
      </div>

      <h2 class="h2-center-white helpwrap" id="puttHelpWrap">
        <span class="helpbtn" id="puttHelpBtn">Input Putt 1 Result <span class="subNote">(distance from hole)</span></span>
        <span class="tip" id="puttHelpTip">Enter how short/long and which side (L/R) the ball finished after the first putt.</span>
      </h2>

      <div class="row divider-2cols" style="margin-top:8px;">
        <div class="field">
          <div class="microlabel ml-left">Short</div>
          <div class="microlabel ml-right">Long</div>
          <div class="stepper">
            <button class="step" id="depthDownP1">▼</button>
            <div class="readout">
              <input id="depthInputP1" class="readnum" type="text" inputmode="text" pattern="-?\d{1,2}" maxlength="3" value="0" aria-label="Putt 1 depth signed feet" />
              <span class="unit">ft</span>
            </div>
            <button class="step" id="depthUpP1">▲</button>
          </div>
          <div id="depthModeTagP1" class="modeTag">Exact</div>
          <div class="capHint" id="capHintDepthP1">Capped at ±99</div>
        </div>
        <div class="vdiv" aria-hidden="true"></div>
        <div class="field">
          <div class="microlabel ml-left">Left</div>
          <div class="microlabel ml-right">Right</div>
          <div class="stepper">
            <button class="step" id="lineLeftP1">◀</button>
            <div class="readout">
              <input id="lineInputP1" class="readnum" type="text" inputmode="text" pattern="-?\d{1,2}" maxlength="3" value="0" aria-label="Putt 1 line signed feet" />
              <span class="unit">ft</span>
            </div>
            <button class="step" id="lineRightP1">▶</button>
          </div>
          <div id="lineModeTagP1" class="modeTag">Straight</div>
          <div class="capHint" id="capHintLineP1">Capped at ±99</div>
        </div>
      </div>
    </section>

    <!-- Putts 2 & 3 -->
    <section class="panel hidden" id="sectionP23">
      <h2 class="h2-center-white helpwrap" id="p23HeaderWrap">
        <span class="helpbtn" id="p23HeaderBtn">Putts 2 & 3 (distances only)</span>
        <span class="tip" id="p23HeaderTip">Derived leave after Putt 1: —</span>
      </h2>
      <div class="row" style="margin-top:8px;">
        <div class="field">
          <div class="subtle">Putt 2 (ft)</div>
          <div class="input"><input id="putt2" type="number" min="0" step="1" placeholder="0" inputmode="numeric" /></div>
        </div>
        <div class="field">
          <div class="subtle">Putt 3 (ft)</div>
          <div class="input"><input id="putt3" type="number" min="0" step="1" placeholder="0" inputmode="numeric" /></div>
        </div>
      </div>
    </section>

    <!-- Save / Reset -->
    <section class="panel footer">
      <button class="btn save" id="saveBtn">Save Hole: —</button>
      <div class="scoreline"><strong>Score:</strong> <span id="score">—</span></div>
      <div></div>
      <button class="btn undo" id="undoBtn">Reset Hole</button>
    </section>

    <!-- Log -->
    <section class="panel">
      <table class="tight">
        <thead>
          <tr>
            <th>#</th><th>Date</th><th>Lie</th><th>Dist</th>
            <th>Putt 1</th><th>Putt 2</th><th>Putt 3</th><th>Score</th>
          </tr>
        </thead>
        <tbody id="logBody"></tbody>
      </table>
    </section>

    <!-- Chart toggle -->
    <section class="panel">
      <button class="btn full chartToggle" id="toggleChartBtn">Show Dispersion Chart</button>
    </section>

    <!-- Chart + filters -->
    <section class="panel hidden" id="chartPanel">
      <h2 style="display:flex;justify-content:space-between;align-items:center; gap:8px; color:#fff; font-size:16px;">
        <span>Session Dispersion (ft)</span>
        <span class="seg" id="colorModeSeg">
          <button data-mode="lie" class="active">Lie</button>
          <button data-mode="distance">Distance</button>
        </span>
      </h2>
      <canvas id="chipChart" width="380" height="280"></canvas>
      <div class="filterbar subtle" id="dynFilterRow"></div>
      <div style="display:flex;justify-content:flex-end;margin-top:8px;flex-wrap:wrap;gap:8px;">
        <button class="rowbtn" id="resetFiltersBtn">Reset filters</button>
      </div>
    </section>
  </main>
</div>

<!-- ========================= TRENDS VIEW ========================= -->
<div id="view-trends" class="hidden">
  <div class="hdr">
    <button class="back" id="backToEditor" aria-label="Back">‹</button>
    <h2>Stats/Trends</h2>
    <div class="tools">
      <button class="tbtn" id="exportAllCSV">CSV</button>
      <button class="tbtn" id="exportJSONTrends" title="Backup JSON">JSON</button>
      <label class="tbtn" for="importJSONInput" title="Import JSON">Import</label>
      <input type="file" id="importJSONInput" accept="application/json" hidden />
    </div>
  </div>

  <div class="pickRow">
    <select id="sessionPick"><option value="">All sessions</option></select>
    <button class="tbtn primary" id="openInEditor">Open in editor</button>
    <button class="tbtn danger" id="deleteSessionBtn" style="display:none">Delete session</button>
    <span id="idbWarn" class="notice" style="display:none">IndexedDB unavailable.</span>
  </div>

  <div class="twrap">
    <div class="tseg" role="tablist" aria-label="Sections">
      <button class="active" data-tab="chip" role="tab" aria-selected="true">Chipping</button>
      <button data-tab="putt" role="tab" aria-selected="false">Putting</button>
      <button data-tab="ud" role="tab" aria-selected="false">Up &amp; Down</button>
    </div>

    <!-- CHIPPING -->
    <section id="tab-chip">
      <div class="kpis">
        <div class="kpi">
          <div class="big" id="chipAvgLeave">–</div>
          <div class="label">Avg leave (ft)</div>
        </div>
        <div class="kpi">
          <div class="big" id="chipTotalShots">–</div>
          <div class="label">Total # of Shots</div>
        </div>
      </div>

      <div class="chips" id="lieChipsT">
        <span class="chip active" data-lie="All">All</span>
        <span class="chip" data-lie="Fairway">Fairway</span>
        <span class="chip" data-lie="Rough">Rough</span>
        <span class="chip" data-lie="Sand">Sand</span>
        <span class="chip" data-lie="Recovery">Recovery</span>
      </div>

      <section class="card">
        <table>
          <thead>
            <tr>
              <th>Dist to Pin (Yds)</th>
              <th class="right"># of Shots</th>
              <th class="right">Avg leave w/ direction</th>
            </tr>
          </thead>
          <tbody id="chipRows"></tbody>
        </table>
      </section>
    </section>

    <!-- PUTTING -->
    <section id="tab-putt" class="hidden">
      <div class="kpis">
        <div class="kpi">
          <div class="big" id="puttHeadline">–</div>
          <div class="label">avg 1st putt leave</div>
        </div>
        <div class="kpi">
          <div class="big" id="puttTotal">–</div>
          <div class="label">Total # of Putts</div>
        </div>
      </div>

      <section class="card">
        <table>
          <thead>
            <tr>
              <th>Dist to Pin (Ft)</th>
              <th class="right"># of Putts</th>
              <th class="right">Avg leave w/ direction </th>
            </tr>
          </thead>
          <tbody id="puttRows"></tbody>
        </table>
      </section>
      <p class="notice">“Avg leave w/ direction” uses the signed leave after Putt 1.</p>
    </section>

    <!-- UP & DOWN -->
    <section id="tab-ud" class="hidden">
      <div class="kpis">
        <div class="kpi"><div class="big" id="udShots">–</div><div class="label"># of Shots</div></div>
        <div class="kpi"><div class="big" id="udWins">–</div><div class="label">Total Up &amp; Downs</div></div>
      </div>
      <div class="kpis">
        <div class="kpi" style="grid-column:1 / -1">
          <div class="big" id="udRate">–</div>
          <div class="label">Avg Success Rate</div>
        </div>
      </div>
      <section class="card" style="padding:12px">
        <div class="chips">
          <span class="chip" id="roll7">7-day: –</span>
          <span class="chip" id="roll30">30-day: –</span>
        </div>
        <div class="notice">Success = score ≤ 2 (chip-ins count).</div>
      </section>
    </section>
  </div>
</div>

<script>
  /* ===== Helpers ===== */
  const pad2 = n => String(n).padStart(2,'0');
  const todayLocalISO = () => { const d = new Date(); return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; };
  const formatLocalISO = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const parseISOAsLocal = (iso) => { const [y,m,d] = (iso||'').split('-').map(x=>parseInt(x,10)); if(!y||!m||!d) return new Date(); return new Date(y, m-1, d); };
  const escapeHTML = (s) => String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;");
  const sanitizeCsvCell = (cell) => {
  let s = String(cell ?? "").replace(/\r/g, "").replace(/\n/g, " ");
  const t = s.trim();
  const isPureNumber = /^-?\d+(?:\.\d+)?$/.test(t); // integers/decimals, optional leading -

  // Only harden if it starts like a formula AND it's not just a number
  if (!isPureNumber && /^[=+\-@]/.test(t)) s = "'" + s;

  if (/[",]/.test(s)) s = '"' + s.replace(/"/g, '""') + '"';
  return s;
};

  /* ===== View switching ===== */
  const viewHome   = document.getElementById('view-home');
  const viewEditor = document.getElementById('view-editor');
  const viewTrends = document.getElementById('view-trends');
  function showView(which){
    viewHome.classList.toggle('hidden',   which!=='home');
    viewEditor.classList.toggle('hidden', which!=='editor');
    viewTrends.classList.toggle('hidden', which!=='trends');
  }
  document.getElementById('startSessionBtn').onclick = ()=> showView('editor');
  document.getElementById('homeTrendsBtn').onclick   = ()=>{ initTrends().then(()=>showView('trends')); };
  document.getElementById('goTrendsBtn').onclick     = ()=>{ initTrends().then(()=>showView('trends')); };
  document.getElementById('backToEditor').onclick    = ()=> showView('editor');

  /* ===== IndexedDB ===== */
  const DB_NAME = 'par2';
  function openPar2DB(){
    return new Promise((res, rej)=>{
      const req = indexedDB.open(DB_NAME, 1);
      req.onupgradeneeded = ()=>{
        const db = req.result;
        if (!db.objectStoreNames.contains('sessions'))
          db.createObjectStore('sessions', { keyPath:'id' });
        if (!db.objectStoreNames.contains('holes')){
          const st = db.createObjectStore('holes', { keyPath:'uid', autoIncrement:true });
          st.createIndex('by_session', 'sessionId', { unique:false });
        }
      };
      req.onsuccess = ()=> res(req.result);
      req.onerror  = ()=> rej(req.error);
    });
  }
  function idbAdd(store, value){
    return new Promise((res, rej)=>{
      const r = store.add(value);
      r.onsuccess = ()=> res(r.result);
      r.onerror = ()=> rej(r.error);
    });
  }
  async function idbAll(storeName){
    const db = await openPar2DB();
    return new Promise((res, rej)=>{
      const tx = db.transaction(storeName, 'readonly');
      const st = tx.objectStore(storeName);
      const out = [];
      st.openCursor().onsuccess = (e)=>{
        const c = e.target.result;
        if (c){ out.push(c.value); c.continue(); } else { db.close(); res(out); }
      };
      tx.onerror = ()=> rej(tx.error);
    });
  }
  async function idbGetHolesBySession(sessionId){
    const db = await openPar2DB();
    return new Promise((res, rej)=>{
      const tx = db.transaction('holes', 'readonly');
      const idx = tx.objectStore('holes').index('by_session');
      const out = [];
      const q = IDBKeyRange.only(sessionId);
      idx.openCursor(q).onsuccess = (e)=>{
        const c = e.target.result;
        if (c){ out.push(c.value); c.continue(); } else { db.close(); res(out); }
      };
      tx.onerror = ()=> rej(tx.error);
    });
  }
  async function idbDeleteSession(sessionId){
    const db = await openPar2DB();
    return new Promise((res, rej)=>{
      const tx = db.transaction(['sessions','holes'], 'readwrite');
      const sessions = tx.objectStore('sessions');
      const holes = tx.objectStore('holes');
      sessions.delete(sessionId);
      const idx = holes.index('by_session');
      const q = IDBKeyRange.only(sessionId);
      idx.openCursor(q).onsuccess = (e)=>{
        const c = e.target.result;
        if (c){ holes.delete(c.primaryKey); c.continue(); }
      };
      tx.oncomplete = ()=>{ db.close(); res(true); };
      tx.onerror = ()=> rej(tx.error);
    });
  }
  function idbDeleteWholeDB(){
    return new Promise((res, rej)=>{
      const r = indexedDB.deleteDatabase(DB_NAME);
      r.onsuccess=()=>res();
      r.onerror = ()=>rej(r.error);
      r.onblocked=()=>alert('Close other tabs using this app to finish importing.');
    });
  }

  /* ===== Editor logic ===== */
  const r0 = (n) => Math.round(Number(n) || 0);
  const clamp = (n, min, max) => Math.max(min, Math.min(max, n));

  let selectedDist = null, selectedLie = "", saved = [];
  let colorMode = "lie";
  const activeCats = { Fairway:true, Rough:true, Sand:true, Recovery:true, d1:true, d2:true, d3:true };
  const includeChipInsInUpDown = true;
  let workingSessionId = '';

  const holeInput = document.getElementById("hole");
  const dateInput = document.getElementById("date");
  const saveBtn   = document.getElementById("saveBtn");
  const putt1El = document.getElementById('putt1Dist');
  const putt2El = document.getElementById('putt2');
  const putt3El = document.getElementById('putt3');

  function updateSaveLabel(){
    const n = parseInt(holeInput.value||"",10);
    saveBtn.textContent = `Save Hole: ${Number.isFinite(n) && n>0 ? n : "—"}`;
  }

  document.getElementById("holeMinus").onclick = () => { holeInput.value = Math.max(1, parseInt(holeInput.value||"1")-1); onHoleChange(); };
  document.getElementById("holePlus").onclick  = () => { holeInput.value = parseInt(holeInput.value||"1")+1; onHoleChange(); };
  holeInput.addEventListener('change', onHoleChange);

  dateInput.value = todayLocalISO();
  updateSaveLabel();

  function formatMMDDYYYY(iso){
    if (!iso) return "";
    const [y, m, d] = iso.split("-");
    if (!y || !m || !d) return iso;
    return `${m.padStart(2,"0")}-${d.padStart(2,"0")}-${y}`;
  }

  // session header
  async function updateSessionHeader(){
    const labelEl = document.getElementById('sessionHeader');
    const dateStr = dateInput.value || todayLocalISO();
    try{
      const sessions = await idbAll('sessions');
      const sameDay = sessions
        .filter(s => (s.dateStart||'') === dateStr)
        .sort((a,b)=> (a.createdAt||'').localeCompare(b.createdAt||''));
      let n = sameDay.length + 1;
      if (workingSessionId){
        const idx = sameDay.findIndex(s=> s.id === workingSessionId);
        if (idx >= 0) n = idx + 1;
      }
      labelEl.textContent = `Session: ${formatMMDDYYYY(dateStr)} (${n})`;
    }catch{
      labelEl.textContent = `Session: ${formatMMDDYYYY(dateStr)} (1)`;
    }
  }
  dateInput.addEventListener('change', updateSessionHeader);

  function smoothFocus(el){
    if (!el) return;
    requestAnimationFrame(()=> setTimeout(()=> el.scrollIntoView({ behavior:'smooth', block:'center' }), 30));
  }

  const distButtons = Array.from(document.querySelectorAll("#distanceGrid button"));
  distButtons.forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const val = parseInt(btn.textContent,10);
      if (btn.classList.contains('active')) {
        btn.classList.remove('active'); selectedDist = null;
      } else {
        distButtons.forEach(b=>b.classList.remove("active"));
        btn.classList.add("active"); selectedDist = val;
        if (selectedLie && !document.getElementById('chipSection').classList.contains('hidden')){
          smoothFocus(document.getElementById('chipSection'));
        }
      }
      calcAll();
    });
  });

  const lieButtons = document.querySelectorAll("#lieChips .pill");
  function updateChipVisibility(scrollOnShow=false){
    const sec = document.getElementById("chipSection");
    const shouldShow = !!selectedLie; // chip stepper only appears when a lie is chosen
    sec.classList.toggle("hidden", !shouldShow);
    if (shouldShow && scrollOnShow) smoothFocus(sec);
  }
  lieButtons.forEach(p=>{
    p.addEventListener("click", ()=>{
      const already = p.classList.contains('active');
      lieButtons.forEach(x=>x.classList.remove("active"));
      if (already) { selectedLie = ""; updateChipVisibility(false); }
      else { p.classList.add("active"); selectedLie = p.dataset.lie; updateChipVisibility(true); }
      calcAll();
    });
  });

  let depthSigned = 0, lineSigned  = 0;
  const depthInputEl = document.getElementById('depthInput');
  const lineInputEl  = document.getElementById('lineInput');
  const depthTag   = document.getElementById('depthModeTag');
  const lineTag    = document.getElementById('lineModeTag');
  const capDepthChip = document.getElementById('capHintDepthChip');
  const capLineChip  = document.getElementById('capHintLineChip');

  let pendingDepth=false, pendingLine=false;
  function showCap(el){ el.classList.add('show'); setTimeout(()=> el.classList.remove('show'), 1200); }
  function normalizeSignedText(el){
    let raw = (el.value||"");
    let v = raw.replace(/[–−]/g,'-').replace(/[^0-9-]/g,'');
    if (v === '' || v === '-') return {pending:true, num:0, text:v, capped:false};
    let n = parseInt(v,10); if (isNaN(n)) n = 0;
    const capped = n > 99 || n < -99;
    n = clamp(n, -99, 99);
    return {pending:false, num:n, text:String(n), capped};
  }
  function updateChipStepperUI(){
    if (!pendingDepth) depthInputEl.value = String(depthSigned);
    if (!pendingLine)  lineInputEl.value  = String(lineSigned);
    depthTag.textContent = depthSigned<0? 'Short' : depthSigned>0? 'Long' : 'Exact';
    lineTag.textContent  = lineSigned<0 ? 'Left'  : lineSigned>0 ? 'Right': 'Straight';
  }

  function addAutoRepeat(btn, stepFn){
    let holdT=null, repI=null, active=false;
    const start=(e)=>{ e.preventDefault(); if(active) return; active=true; stepFn();
      holdT=setTimeout(()=>{ repI=setInterval(()=>{ stepFn(); }, 80); }, 400);
    };
    const stop=()=>{ active=false; clearTimeout(holdT); clearInterval(repI); holdT=null; repI=null; };
    btn.addEventListener('mousedown', start);
    btn.addEventListener('touchstart', start, {passive:false});
    ['mouseup','mouseleave','touchend','touchcancel'].forEach(ev=> btn.addEventListener(ev, stop));
  }

  const depthDown = document.getElementById('depthDown');
  const depthUp   = document.getElementById('depthUp');
  const lineLeft  = document.getElementById('lineLeft');
  const lineRight = document.getElementById('lineRight');

  depthDown.onclick = ()=>{ pendingDepth=false; const prev=depthSigned; depthSigned = clamp(depthSigned - 1, -99, 99); if(prev===-99) showCap(capDepthChip); updateChipStepperUI(); calcAll(); };
  depthUp.onclick   = ()=>{ pendingDepth=false; const prev=depthSigned; depthSigned = clamp(depthSigned + 1, -99, 99); if(prev===99)  showCap(capDepthChip); updateChipStepperUI(); calcAll(); };
  lineLeft.onclick  = ()=>{ pendingLine=false;  const prev=lineSigned;  lineSigned  = clamp(lineSigned  - 1, -99, 99); if(prev===-99) showCap(capLineChip);  updateChipStepperUI(); calcAll(); };
  lineRight.onclick = ()=>{ pendingLine=false;  const prev=lineSigned;  lineSigned  = clamp(lineSigned  + 1, -99, 99); if(prev===99)  showCap(capLineChip);  updateChipStepperUI(); calcAll(); };

  addAutoRepeat(depthDown, ()=>{ const prev=depthSigned; depthSigned=clamp(depthSigned-1,-99,99); if(prev===-99) showCap(capDepthChip); updateChipStepperUI(); calcAll(); });
  addAutoRepeat(depthUp,   ()=>{ const prev=depthSigned; depthSigned=clamp(depthSigned+1,-99,99); if(prev===99)  showCap(capDepthChip); updateChipStepperUI(); calcAll(); });
  addAutoRepeat(lineLeft,  ()=>{ const prev=lineSigned;  lineSigned =clamp(lineSigned -1,-99,99); if(prev===-99) showCap(capLineChip);  updateChipStepperUI(); calcAll(); });
  addAutoRepeat(lineRight, ()=>{ const prev=lineSigned;  lineSigned =clamp(lineSigned +1,-99,99); if(prev===99)  showCap(capLineChip);  updateChipStepperUI(); calcAll(); });

  depthInputEl.addEventListener('focus', ()=> depthInputEl.select());
  lineInputEl .addEventListener('focus', ()=> lineInputEl.select());
  depthInputEl.addEventListener('input', ()=>{
    const r = normalizeSignedText(depthInputEl);
    pendingDepth=r.pending; depthSigned=r.num; if(!r.pending) depthInputEl.value=r.text; if(r.capped) showCap(capDepthChip);
    updateChipStepperUI(); calcAll();
  });
  lineInputEl .addEventListener('input', ()=>{
    const r = normalizeSignedText(lineInputEl );
    pendingLine=r.pending;  lineSigned=r.num; if(!r.pending) lineInputEl.value=r.text;  if(r.capped) showCap(capLineChip);
    updateChipStepperUI(); calcAll();
  });

  let depthSignedP1 = 0, lineSignedP1 = 0;
  const depthInputP1 = document.getElementById('depthInputP1');
  const lineInputP1  = document.getElementById('lineInputP1');
  const depthTagP1   = document.getElementById('depthModeTagP1');
  const lineTagP1    = document.getElementById('lineModeTagP1');
  const capDepthP1   = document.getElementById('capHintDepthP1');
  const capLineP1    = document.getElementById('capHintLineP1');

  let pendingDepthP1=false, pendingLineP1=false;
  function updateP1StepperUI(){
    if (!pendingDepthP1) depthInputP1.value = String(depthSignedP1);
    if (!pendingLineP1)  lineInputP1.value  = String(lineSignedP1);
    depthTagP1.textContent = depthSignedP1<0? 'Short' : depthSignedP1>0? 'Long' : 'Exact';
    lineTagP1.textContent  = lineSignedP1<0 ? 'Left'  : lineSignedP1>0 ? 'Right': 'Straight';
  }

  const depthDownP1 = document.getElementById('depthDownP1');
  const depthUpP1   = document.getElementById('depthUpP1');
  const lineLeftP1  = document.getElementById('lineLeftP1');
  const lineRightP1 = document.getElementById('lineRightP1');

  depthDownP1.onclick = ()=>{ pendingDepthP1=false; const prev=depthSignedP1; depthSignedP1 = clamp(depthSignedP1 - 1, -99, 99); if(prev===-99) capDepthP1.classList.add('show'); updateP1StepperUI(); calcAll(); setTimeout(()=>capDepthP1.classList.remove('show'),1200); };
  depthUpP1.onclick   = ()=>{ pendingDepthP1=false; const prev=depthSignedP1; depthSignedP1 = clamp(depthSignedP1 + 1, -99, 99); if(prev===99)  capDepthP1.classList.add('show'); updateP1StepperUI(); calcAll(); setTimeout(()=>capDepthP1.classList.remove('show'),1200); };
  lineLeftP1.onclick  = ()=>{ pendingLineP1=false;  const prev=lineSignedP1;  lineSignedP1  = clamp(lineSignedP1  - 1, -99, 99); if(prev===-99) capLineP1.classList.add('show');  updateP1StepperUI(); calcAll(); setTimeout(()=>capLineP1.classList.remove('show'),1200); };
  lineRightP1.onclick = ()=>{ pendingLineP1=false;  const prev=lineSignedP1;  lineSignedP1  = clamp(lineSignedP1  + 1, -99, 99); if(prev===99)  capLineP1.classList.add('show');  updateP1StepperUI(); calcAll(); setTimeout(()=>capLineP1.classList.remove('show'),1200); };
// HOLD-TO-REPEAT for PUTT 1 (mirrors chip stepper behavior)
addAutoRepeat(depthDownP1, ()=>{ 
  pendingDepthP1=false; const prev=depthSignedP1;
  depthSignedP1 = clamp(depthSignedP1 - 1, -99, 99);
  if(prev===-99){ capDepthP1.classList.add('show'); setTimeout(()=>capDepthP1.classList.remove('show'),1200); }
  updateP1StepperUI(); calcAll();
});
addAutoRepeat(depthUpP1, ()=>{ 
  pendingDepthP1=false; const prev=depthSignedP1;
  depthSignedP1 = clamp(depthSignedP1 + 1, -99, 99);
  if(prev===99){ capDepthP1.classList.add('show'); setTimeout(()=>capDepthP1.classList.remove('show'),1200); }
  updateP1StepperUI(); calcAll();
});
addAutoRepeat(lineLeftP1, ()=>{ 
  pendingLineP1=false; const prev=lineSignedP1;
  lineSignedP1 = clamp(lineSignedP1 - 1, -99, 99);
  if(prev===-99){ capLineP1.classList.add('show'); setTimeout(()=>capLineP1.classList.remove('show'),1200); }
  updateP1StepperUI(); calcAll();
});
addAutoRepeat(lineRightP1, ()=>{ 
  pendingLineP1=false; const prev=lineSignedP1;
  lineSignedP1 = clamp(lineSignedP1 + 1, -99, 99);
  if(prev===99){ capLineP1.classList.add('show'); setTimeout(()=>capLineP1.classList.remove('show'),1200); }
  updateP1StepperUI(); calcAll();
});
  ["putt1Dist","putt2","putt3"].forEach(id=>{
    const el = document.getElementById(id);
    el.addEventListener("change", () => { el.value = el.value === "" ? "" : r0(el.value); calcAll(); });
    el.addEventListener("input", calcAll);
  });

  // helper toasts (open/close)
  const chipHelpWrap = document.getElementById('chipHelpWrap');
  const chipHelpBtn  = document.getElementById('chipHelpBtn');
  const puttHelpWrap = document.getElementById('puttHelpWrap');
  const puttHelpBtn  = document.getElementById('puttHelpBtn');
  const putt1HeaderWrap = document.getElementById('putt1HeaderWrap');
  const putt1HeaderBtn  = document.getElementById('putt1HeaderBtn');
  const p23HeaderWrap   = document.getElementById('p23HeaderWrap');
  const p23HeaderBtn    = document.getElementById('p23HeaderBtn');

  function closeAllTips(){ [chipHelpWrap, puttHelpWrap, putt1HeaderWrap, p23HeaderWrap].forEach(w=> w && w.classList.remove('open')); }
  function toggleTip(wrap){ const wasOpen = wrap.classList.contains('open'); closeAllTips(); if (!wasOpen) wrap.classList.add('open'); }

  chipHelpBtn.addEventListener('click', (e)=>{ e.stopPropagation(); toggleTip(chipHelpWrap); });
  puttHelpBtn.addEventListener('click', (e)=>{ e.stopPropagation(); toggleTip(puttHelpWrap); });
  putt1HeaderBtn.addEventListener('click', (e)=>{ e.stopPropagation(); toggleTip(putt1HeaderWrap); });
  p23HeaderBtn.addEventListener('click', (e)=>{ e.stopPropagation(); toggleTip(p23HeaderWrap); });
  document.addEventListener('click', closeAllTips);
  window.addEventListener('scroll', closeAllTips, {passive:true});

  function leaveFromSigned(dSigned, lSigned){
    const D = Math.abs(r0(dSigned)), L = Math.abs(r0(lSigned));
    const leave = Math.sqrt(D*D + L*L);
    return { leave:r0(leave), dSigned:r0(dSigned), lSigned:r0(lSigned),
      depthDir: dSigned<0? 'Short' : dSigned>0? 'Long' : 'Exact',
      lineDir:  lSigned<0? 'Left'  : lSigned>0 ? 'Right': 'Straight' };
  }

  function updateVisibility(chipHasInput, p1HasInput){
    document.getElementById("sectionP1").classList.toggle("hidden", !chipHasInput);
    document.getElementById("sectionP23").classList.toggle("hidden", !p1HasInput);
  }

  function updateDerivedBubbles(chip, p1){
    const p1Tip = document.getElementById('putt1HeaderTip');
    p1Tip.textContent = (Math.abs(depthSigned)||Math.abs(lineSigned))
      ? `Derived leave from chip: ${chip.leave} ft (${chip.depthDir} ${Math.abs(chip.dSigned)} / ${chip.lineDir} ${Math.abs(chip.lSigned)})`
      : 'Derived leave from chip: —';
    const p23Tip = document.getElementById('p23HeaderTip');
    p23Tip.textContent = (Math.abs(depthSignedP1)||Math.abs(lineSignedP1))
      ? `Derived leave after Putt 1: ${p1.leave} ft (${p1.depthDir} ${Math.abs(p1.dSigned)} / ${p1.lineDir} ${Math.abs(p1.lSigned)})`
      : 'Derived leave after Putt 1: —';
  }

  function calcAll(){
    const chip = leaveFromSigned(depthSigned, lineSigned);
    const p1   = leaveFromSigned(depthSignedP1, lineSignedP1);

    updateDerivedBubbles(chip, p1);

    // NEW: visibility now also depends on selections (distance & lie)
    const hasSelections = !!(selectedDist && selectedLie);
    const chipHasInput = hasSelections && ((Math.abs(depthSigned) || Math.abs(lineSigned)) > 0);
    const p1HasInput   = chipHasInput && ((Math.abs(depthSignedP1) || Math.abs(lineSignedP1)) > 0);

    document.getElementById("putt1Dist").value = chipHasInput && chip.leave>0 ? chip.leave : "";
    document.getElementById("putt2").value     = p1HasInput   && p1.leave>0   ? p1.leave   : "";

    updateVisibility(chipHasInput, p1HasInput);

    let strokes = 1, putts = 0;
    if (r0(putt1El.value) > 0) putts++;
    if (r0(putt2El.value) > 0) putts++;
    if (r0(putt3El.value) > 0) putts++;
    strokes += putts;
    if (chip.leave===0 && putts===0) strokes = 1;
    document.getElementById("score").textContent = (!selectedDist || !selectedLie) ? "—" : strokes;
  }

  function clearUISelections(){
    document.querySelectorAll("#distanceGrid button").forEach(b=>b.classList.remove("active")); selectedDist=null;
    document.querySelectorAll("#lieChips .pill").forEach(x=>x.classList.remove("active")); selectedLie = "";
    depthSigned=0; lineSigned=0; pendingDepth=false; pendingLine=false; updateChipStepperUI();
    depthSignedP1=0; lineSignedP1=0; pendingDepthP1=false; pendingLineP1=false; updateP1StepperUI();
    document.getElementById("putt1Dist").value="";
    document.getElementById("putt2").value="";
    document.getElementById("putt3").value="";
    document.getElementById("chipSection").classList.add("hidden");
    document.getElementById("sectionP1").classList.add("hidden");
    document.getElementById("sectionP23").classList.add("hidden");
    document.getElementById("score").textContent = "—";
  }

  function applyRowToUI(r){
    clearUISelections();
    selectedDist = Number(r.dist)||null;
    if (selectedDist){
      const btn = Array.from(document.querySelectorAll("#distanceGrid button")).find(b=> Number(b.textContent) === selectedDist);
      if (btn) btn.classList.add('active');
    }
    selectedLie = r.lie || "";
    if (selectedLie){
      document.querySelectorAll('#lieChips .pill')
        .forEach(b=> b.classList.toggle('active', b.dataset.lie===selectedLie));
    }
    updateChipVisibility();

    depthSigned = Number(r.chipDepthSigned||0);
    lineSigned  = Number(r.chipLateralSigned||0);
    updateChipStepperUI();

    depthSignedP1 = Number(r.p1DepthSigned||0);
    lineSignedP1  = Number(r.p1LateralSigned||0);
    updateP1StepperUI();

    document.getElementById("putt1Dist").value = r.p1 || '';
    document.getElementById("putt2").value = r.p2 || '';
    document.getElementById("putt3").value = r.p3 || '';

    const hasSelections = !!(selectedDist && selectedLie);
    const chipHasInput = hasSelections && ((Math.abs(depthSigned) || Math.abs(lineSigned)) > 0);
    const p1HasInput   = chipHasInput && ((Math.abs(depthSignedP1) || Math.abs(lineSignedP1)) > 0);
    updateVisibility(chipHasInput, p1HasInput);
    calcAll();
  }
  function findSavedByHole(h){ const list = saved.filter(x => Number(x.hole) === Number(h)); return list.length ? list[list.length-1] : null; }
  function onHoleChange(){ const h = parseInt(holeInput.value || '1', 10); const rec = findSavedByHole(h); if (rec) applyRowToUI(rec); else clearUISelections(); updateSaveLabel(); }

  function renderLog(){
    const tbody = document.getElementById("logBody");
    tbody.innerHTML = "";
    saved.forEach((r,idx)=>{
      const tr = document.createElement("tr");
      tr.dataset.idx = idx;

      const cells = [
        String(r.hole),
        formatMMDDYYYY(r.date),
        r.lie,
        `${r.dist} yd`,
        r.p1 ? `${r.p1} ft` : "",
        r.p2 ? `${r.p2} ft` : "",
        r.p3 ? `${r.p3} ft` : ""
      ].map(escapeHTML);

      for (let i=0;i<7;i++){
        const td=document.createElement('td');
        td.innerHTML = cells[i];
        tr.appendChild(td);
      }

      const tdScore = document.createElement('td');
      tdScore.className = 'score-cell';
      tdScore.innerHTML = `${escapeHTML(String(r.score))}<button class="rowbtn" data-del="${idx}" title="Delete">🗑</button>`;
      tr.appendChild(tdScore);

      tbody.appendChild(tr);
    });
    tbody.querySelectorAll('button[data-del]').forEach(btn=>{
      btn.onclick = ()=>{
        const i = Number(btn.getAttribute('data-del'));
        saved.splice(i,1);
        renderLog();
      };
    });

    const holes = saved.length, par = holes*2, total = saved.reduce((s,r)=>s+(Number(r.score)||0),0);
    const successes = saved.filter(r => (includeChipInsInUpDown ? r.score <= 2 : r.score === 2)).length;
    const updownPct = holes ? Math.round((successes/holes)*100) : 0;
    const over = total - par; const overLabel = over > 0 ? `+${over}` : `${over}`;
    document.getElementById("summaryBarTop").textContent =
      `Par: ${par} | Gross: ${total} | Up/Down: ${updownPct}% | To Par: ${overLabel}`;

    renderFilterRow(); renderChart();
  }

  /* ========== Download helpers ========== */

  // 1) Anchor/ObjectURL download: keep CSV behavior exactly like the old flow.
  function downloadViaAnchor(filename, blob){
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.rel = 'noopener';
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1500);
  }

  // 2) JSON: prefer iOS Web Share with files, else fall back to anchor, then data URL.
  function downloadJSONSmart(filename, blob){
    const file = new File([blob], filename, { type: blob.type || 'application/json' });

    if (navigator.canShare && navigator.canShare({ files: [file] })) {
      navigator.share({ files: [file], title: filename })
        .catch(()=> downloadViaAnchor(filename, blob));
      return;
    }

    // Anchor path
    try {
      downloadViaAnchor(filename, blob);
      return;
    } catch {}

    // Very old fallback
    const reader = new FileReader();
    reader.onload = () => {
      const dataUrl = reader.result;
      const win = window.open(dataUrl, '_blank', 'noopener,noreferrer');
      if (!win) window.location.href = dataUrl;
    };
    reader.readAsDataURL(file);
  }

  /* ===== Export CSV (editor) — old Safari-friendly flow ===== */
  document.getElementById("exportBtn").addEventListener("click", () => {
    const cols = [
      "hole","date","lie","dist_yd",
      "chip_leave_ft","chip_depth_ft","chip_lateral_ft","chip_depth_dir","chip_line_dir",
      "putt1_ft","putt1_depth_ft","putt1_lateral_ft","putt1_depth_dir","putt1_line_dir",
      "putt2_ft","putt3_ft","score"
    ];
    const rows = [cols];
    saved.forEach(r=>{
      rows.push([
        r.hole, formatMMDDYYYY(r.date), r.lie, r.dist,
        r.chipLeave, r.chipDepthSigned, r.chipLateralSigned, r.chipDepthDir, r.chipLineDir,
        r.p1 || "", r.p1DepthSigned || "", r.p1LateralSigned || "", r.p1DepthDir || "", r.p1LineDir || "",
        r.p2 || "", r.p3 || "", r.score
      ]);
    });
    const csv = rows.map(row => row.map(sanitizeCsvCell).join(",")).join("\n");
    const blob = new Blob(["\ufeff"+csv],{type:"text/csv;charset=utf-8;"});
    downloadViaAnchor('par2_export.csv', blob);
  });

  /* ===== Save Hole + Undo ===== */
  document.getElementById("saveBtn").addEventListener("click", () => {
    if (!selectedDist || !selectedLie){ alert('Please select a Chip Starting Distance and a Lie before saving.'); return; }
    const hole = parseInt(holeInput.value||"1",10);
    const date = dateInput.value || todayLocalISO();

    const chip = leaveFromSigned(depthSigned, lineSigned);
    const p1   = leaveFromSigned(depthSignedP1, lineSignedP1);

    let strokes = 1, putts = 0;
    const p1d = r0(putt1El.value); if (p1d>0) putts++;
    const p2d = r0(putt2El.value); if (p2d>0) putts++;
    const p3d = r0(putt3El.value); if (p3d>0) putts++;
    strokes += putts;
    if (chip.leave===0 && putts===0) strokes = 1;

    const row = {
      hole, date, lie: selectedLie || "", dist: selectedDist ?? "",
      chipLeave: chip.leave, chipDepthSigned: chip.dSigned, chipLateralSigned: chip.lSigned,
      chipDepthDir: chip.depthDir, chipLineDir: chip.lineDir,
      chipX: chip.lSigned, chipY: chip.dSigned,
      p1: p1d || "", p1DepthSigned: p1.dSigned || "", p1LateralSigned: p1.lSigned || "",
      p1DepthDir: p1.depthDir || "", p1LineDir: p1.lineDir || "",
      p2: p2d || "", p3: p3d || "", score: strokes
    };

    const idx = saved.findIndex(x => Number(x.hole) === hole);
    if (idx >= 0) saved[idx] = row; else saved.push(row);

    renderLog();
    holeInput.value = hole + 1;
    updateSaveLabel();
    clearUISelections();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  document.getElementById("undoBtn").addEventListener("click", () => {
    clearUISelections();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  // NEW: New Session button
  document.getElementById('newSessionBtn').addEventListener('click', ()=>{
    if (!confirm('Would you like to start a new session? Current session will be lost unless saved.')) return;
    saved = [];
    workingSessionId = '';
    renderLog();
    holeInput.value = 1;
    dateInput.value = todayLocalISO();
    updateSaveLabel();
    clearUISelections();
    document.getElementById('chartPanel').classList.add('hidden');
    document.getElementById('toggleChartBtn').textContent = 'Show Dispersion Chart';
    updateSessionHeader();
    window.scrollTo({ top:0, behavior:'smooth' });
  });

  document.getElementById('resetFiltersBtn').addEventListener('click', ()=>{
    Object.keys(activeCats).forEach(k=> activeCats[k] = true); renderFilterRow(); renderChart();
  });

  const chartPanel = document.getElementById('chartPanel');
  const toggleChartBtn = document.getElementById('toggleChartBtn');
  toggleChartBtn.addEventListener('click', ()=>{
    const willShow = chartPanel.classList.contains('hidden');
    if (willShow){
      chartPanel.classList.remove('hidden');
      toggleChartBtn.textContent = 'Hide Dispersion Chart';
      renderChart();
      setTimeout(()=> chartPanel.scrollIntoView({behavior:'smooth', block:'start'}), 50);
    } else {
      chartPanel.classList.add('hidden');
      toggleChartBtn.textContent = 'Show Dispersion Chart';
    }
  });

  // NEW: wire color-mode toggle (Lie / Distance)
  document.querySelectorAll('#colorModeSeg button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('#colorModeSeg button').forEach(x=>x.classList.remove('active'));
      btn.classList.add('active');
      colorMode = btn.dataset.mode;   // 'lie' or 'distance'
      renderFilterRow();
      renderChart();
    });
  });

  function renderFilterRow(){
    const row = document.getElementById('dynFilterRow');
    row.innerHTML = "";
    if (colorMode === "lie"){
      ["Fairway","Rough","Sand","Recovery"].forEach(k=>{
        const span = document.createElement('span');
        span.className = `flt flt-${k.toLowerCase()} ${activeCats[k] ? "" : "off"}`;
        span.textContent = k;
        span.onclick = ()=>{ activeCats[k] = !activeCats[k]; span.classList.toggle('off', !activeCats[k]); renderChart(); };
        row.appendChild(span);
      });
    } else {
      [{k:"d1",label:"10–25 yd"},{k:"d2",label:"30–45 yd"},{k:"d3",label:"50–65 yd"}].forEach(({k,label})=>{
        const span = document.createElement('span');
        span.className = `flt flt-${k} ${activeCats[k] ? "" : "off"}`;
        span.textContent = label;
        span.onclick = ()=>{ activeCats[k] = !activeCats[k]; span.classList.toggle('off', !activeCats[k]); renderChart(); };
        row.appendChild(span);
      });
    }
  }

  function bucketForDistance(d){
    d = Number(d)||0;
    if (d>=10 && d<=25) return 'd1';
    if (d>=30 && d<=45) return 'd2';
    if (d>=50 && d<=65) return 'd3';
    return 'd1';
  }
  function colorFor(row){
    if (colorMode === 'lie'){
      switch((row.lie||"").toLowerCase()){
        case "fairway":  return "#7CFC00";
        case "rough":    return "#ffa74d";
        case "sand":     return "#e8d27c";
        case "recovery": return "#ff5a5a";
        default:         return "#e8ecf1";
      }
    } else {
      const b = bucketForDistance(row.dist);
      return (b==='d1') ? "#9cdcfe" : (b==='d2') ? "#a6e22e" : "#ffb454";
    }
  }

  function renderChart(){
    const cv = document.getElementById('chipChart'); if (!cv) return;
    const ctx = cv.getContext('2d'); const W=cv.width, H=cv.height;
    ctx.clearRect(0,0,W,H);

    const pts = saved.filter(r=>{
      if (colorMode === "lie") return activeCats[r.lie ?? ""] === true;
      const b = bucketForDistance(r.dist);
      return activeCats[b] === true;
    }).map(r => ({x:r.chipX, y:r.chipY, c:colorFor(r)}));

    const maxAbs = Math.max(5, ...pts.map(p => Math.max(Math.abs(p.x), Math.abs(p.y))), 5);
    const pad = 10, scale = (Math.min(W,H)/2 - pad) / (maxAbs || 5);
    const cx=W/2, cy=H/2;

    ctx.strokeStyle = '#2a3138'; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(0,cy); ctx.lineTo(W,cy); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(cx,0); ctx.lineTo(cx,H); ctx.stroke();

    ctx.fillStyle = '#9aa7b2'; ctx.font='11px system-ui';
    for (let t=-maxAbs; t<=maxAbs; t+=5){
      const x = cx + t*scale, y = cy - t*scale;
      ctx.strokeStyle='#2a3138';
      ctx.beginPath(); ctx.moveTo(x,cy-3); ctx.lineTo(x,cy+3); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(cx-3,y); ctx.lineTo(cx+3,y); ctx.stroke();
      if (t!==0){ ctx.fillText(String(t), x-6, cy+14); ctx.fillText(String(t), cx+6, y+3); }
    }

    let mx=0,my=0,r=0;
    if (pts.length){
      mx = pts.reduce((s,p)=>s+p.x,0)/pts.length;
      my = pts.reduce((s,p)=>s+p.y,0)/pts.length;
      r  = Math.sqrt(pts.reduce((s,p)=>s+(p.x-mx)*(p.x-mx)+(p.y-my)*(p.y-my),0)/pts.length);
    }
    ctx.strokeStyle='#2ea043'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.arc(cx + mx*scale, cy - my*scale, r*scale, 0, Math.PI*2); ctx.stroke();
    ctx.fillStyle='#2ea043'; ctx.beginPath(); ctx.arc(cx + mx*scale, cy - my*scale, 3, 0, Math.PI*2); ctx.fill();

    pts.forEach(p=>{
      ctx.beginPath(); ctx.arc(cx + p.x*scale, cy - p.y*scale, 2.8, 0, Math.PI*2);
      ctx.fillStyle=p.c; ctx.fill(); ctx.lineWidth=.8; ctx.strokeStyle='rgba(255,255,255,.9)'; ctx.stroke();
    });
  }

  // Save/Update Session -> IndexedDB
  document.getElementById('saveSessionBtn').addEventListener('click', async ()=>{
    if (!saved.length){ alert('Nothing to save yet. Add at least one hole.'); return; }
    const isUpdate = !!workingSessionId;
    try{
      const db = await openPar2DB();
      const tx = db.transaction(['sessions','holes'], 'readwrite');
      const sessions = tx.objectStore('sessions');
      const holes = tx.objectStore('holes');

      const dateStrs = saved.map(r=> r.date || todayLocalISO());
      const datesLocal = dateStrs.map(parseISOAsLocal);
      const minDate = new Date(Math.min(...datesLocal.map(d=>d.getTime())));
      const maxDate = new Date(Math.max(...datesLocal.map(d=>d.getTime())));

      let id = workingSessionId || `s_${Date.now()}`;
      if (isUpdate){
        const idx = holes.index('by_session');
        const q = IDBKeyRange.only(id);
        await new Promise((resolve,reject)=>{
          idx.openCursor(q).onsuccess = (e)=>{
            const c = e.target.result;
            if (c){ holes.delete(c.primaryKey); c.continue(); } else resolve();
          };
          tx.onerror = ()=> reject(tx.error);
        });
        await new Promise((res,rej)=>{
          const r = sessions.put({ id, createdAt:new Date().toISOString(),
            dateStart:formatLocalISO(minDate),
            dateEnd:formatLocalISO(maxDate),
            holes: saved.length });
          r.onsuccess=()=>res(); r.onerror=()=>rej(r.error);
        });
      } else {
        await new Promise((res,rej)=>{
          const r = sessions.add({ id, createdAt:new Date().toISOString(),
            dateStart:formatLocalISO(minDate),
            dateEnd:formatLocalISO(maxDate),
            holes: saved.length });
          r.onsuccess=()=>res(); r.onerror=()=>rej(r.error);
        });
      }
      for (const r of saved) await idbAdd(holes, { sessionId:id, ...r });
      tx.oncomplete = ()=> db.close();

      saved = [];
      renderLog();
      holeInput.value = 1; updateSaveLabel();
      clearUISelections();
      workingSessionId = '';
      updateSessionHeader();
      alert(isUpdate ? 'Session updated.' : 'Session saved to Stats/Trends.');
    }catch(err){
      console.error(err);
      alert('Could not save session (IndexedDB may be blocked).');
    }
  });

  // ===== Trends logic =====
  let HOLES = [], SESSIONS = [], currentSession = '', chipLie = 'All';

  function chipBucket(dist){
    const d = Number(dist)||0;
    if (d>=10 && d<=25) return '10–25';
    if (d>=30 && d<=45) return '30–45';
    if (d>=50 && d<=65) return '50–65';
    return null;
  }
  function puttBucket(ft){
    const d = Number(ft)||0;
    if (d<=2) return '0–2';
    if (d<=5) return '3–5';
    if (d<=10) return '6–10';
    if (d<=20) return '11–20';
    if (d<=30) return '21–30';
    return '30+';
  }

  async function initTrends(){
    try{
      [SESSIONS, HOLES] = await Promise.all([idbAll('sessions'), idbAll('holes')]);
      SESSIONS.sort((a,b)=> (b.dateStart||'').localeCompare(a.dateStart||'')); // newest day first
      populateSessionPicker();
      wireTrendsUI();
      renderTrendsAll();
      document.getElementById('idbWarn').style.display = (SESSIONS.length||HOLES.length) ? 'none' : 'inline';
    }catch(e){
      console.error(e);
      document.getElementById('idbWarn').style.display = 'inline';
    }
  }

  function populateSessionPicker(){
    const sel = document.getElementById('sessionPick');
    sel.innerHTML = '<option value="">All sessions</option>';

    const byDate = {};
    SESSIONS.forEach(s=>{
      const k = s.dateStart || '';
      (byDate[k] ||= []).push(s);
    });
    Object.values(byDate).forEach(list=>{
      list.sort((a,b)=>(a.createdAt||'').localeCompare(b.createdAt||''));
    });

    SESSIONS.forEach(s=>{
      const opt = document.createElement('option');
      opt.value = s.id;

      const base =
        (s.dateStart===s.dateEnd)
          ? formatMMDDYYYY(s.dateStart)
          : `${formatMMDDYYYY(s.dateStart)} – ${formatMMDDYYYY(s.dateEnd)}`;

      let label = base;
      if (s.dateStart === s.dateEnd){
        const dayList = byDate[s.dateStart] || [];
        const idx = Math.max(1, dayList.findIndex(x=>x.id===s.id) + 1);
        label = `${base} (${idx})`;
      }

      opt.textContent = label;
      sel.appendChild(opt);
    });

    const delBtn = document.getElementById('deleteSessionBtn');
    sel.onchange = ()=>{
      currentSession = sel.value;
      delBtn.style.display = currentSession ? 'inline-flex' : 'none';
      renderTrendsAll();
    };
    document.getElementById('deleteSessionBtn').style.display = currentSession ? 'inline-flex' : 'none';
  }

  function filteredHoles(){
    return HOLES.filter(h=> !currentSession || h.sessionId === currentSession);
  }

  function renderChip(){
    const chipRowsEl = document.getElementById('chipRows');
    const rows = filteredHoles().filter(h=> chipBucket(h.dist) && (chipLie==='All' || h.lie===chipLie));
    const byB = {'10–25':[], '30–45':[], '50–65':[]};
    rows.forEach(r=> byB[chipBucket(r.dist)].push(r));

    function avgMag(list){ if (!list.length) return 0; return list.reduce((s,r)=> s + Math.hypot(r.chipDepthSigned||0, r.chipLateralSigned||0), 0) / list.length; }
    function signedMean(list, key){ if (!list.length) return 0; return list.reduce((s,r)=> s + (Number(r[key])||0), 0) / list.length; }

    document.getElementById('chipTotalShots').textContent = rows.length || '0';
    document.getElementById('chipAvgLeave').textContent = rows.length ? avgMag(rows).toFixed(1) : '–';

    chipRowsEl.innerHTML = '';
    ['10–25','30–45','50–65'].forEach(label=>{
      const list = byB[label], n = list.length;
      const md = signedMean(list,'chipDepthSigned');
      const ml = signedMean(list,'chipLateralSigned');
      const dirD = md<0 ? 'Short' : md>0 ? 'Long' : 'Exact';
      const dirL = ml<0 ? 'Left'  : ml>0 ? 'Right': 'Straight';
      const mag = n ? (list.reduce((s,r)=> s + Math.hypot(r.chipDepthSigned||0, r.chipLateralSigned||0), 0)/n).toFixed(1) : '–';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${label}</td>
        <td class="right">${n||0}</td>
        <td class="right">${n?`${mag} ft (${dirD} ${Math.abs(md).toFixed(1)} / ${dirL} ${Math.abs(ml).toFixed(1)})`:'—'}</td>
      `;
      chipRowsEl.appendChild(tr);
    });
  }

  function renderPutt(){
    const puttRowsEl = document.getElementById('puttRows');
    const rows = filteredHoles().filter(h=> Number(h.p1)>0);
    const byB = {'0–2':[], '3–5':[], '6–10':[], '11–20':[], '21–30':[], '30+':[]};
    rows.forEach(r=> byB[puttBucket(r.p1)].push(r));

    document.getElementById('puttTotal').textContent = rows.length||'0';
    document.getElementById('puttHeadline').textContent = rows.length
      ? (rows.reduce((s,r)=> s + Math.hypot(r.p1DepthSigned||0, r.p1LateralSigned||0), 0)/rows.length).toFixed(2)
      : '–';

    puttRowsEl.innerHTML = '';
    Object.keys(byB).forEach(label=>{
      const list = byB[label], n = list.length;
      const md = n ? list.reduce((s,r)=> s + (Number(r.p1DepthSigned)||0), 0)/n : 0;
      const ml = n ? list.reduce((s,r)=> s + (Number(r.p1LateralSigned)||0), 0)/n : 0;
      const dirD = md<0 ? 'Short' : md>0 ? 'Long' : 'Exact';
      const dirL = ml<0 ? 'Left'  : ml>0 ? 'Right': 'Straight';
      const mag = n ? (list.reduce((s,r)=> s + Math.hypot(r.p1DepthSigned||0, r.p1LateralSigned||0), 0)/n).toFixed(2) : '–';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${label}</td>
        <td class="right">${n||0}</td>
        <td class="right">${n?`${mag} ft (${dirD} ${Math.abs(md).toFixed(2)} / ${dirL} ${Math.abs(ml).toFixed(2)})`:'—'}</td>
      `;
      puttRowsEl.appendChild(tr);
    });
  }

  function renderUD(){
    const rows = filteredHoles();
    const attempts = rows.length;
    const wins = rows.filter(r=> Number(r.score)<=2).length;
    const rate = attempts ? (wins/attempts*100) : 0;

    document.getElementById('udShots').textContent = attempts || '0';
    document.getElementById('udWins').textContent = wins || '0';
    document.getElementById('udRate').textContent = attempts ? `${rate.toFixed(1)}%` : '–';

    const byDay = {};
    rows.forEach(r=>{
      const d = r.date || '';
      if(!byDay[d]) byDay[d] = {a:0,w:0};
      byDay[d].a += 1;
      byDay[d].w += (Number(r.score)<=2) ? 1 : 0;
    });
    const days = Object.keys(byDay).sort();
    function roll(n){
      if (!days.length) return '–';
      const arr = days.map(d=> ({d, a:byDay[d].a, w:byDay[d].w, r: byDay[d].a ? byDay[d].w/byDay[d].a : 0}));
      const last = arr.slice(-n);
      if (!last.length) return '–';
      const avg = last.reduce((s,x)=> s + x.r, 0)/last.length;
      return (avg*100).toFixed(1)+'%';
    }
    document.getElementById('roll7').textContent = '7-day: ' + roll(7);
    document.getElementById('roll30').textContent = '30-day: ' + roll(30);
  }

  function renderTrendsAll(){ renderChip(); renderPutt(); renderUD(); }

  /* ===== Trends UI (incl. JSON/CSV import/export) ===== */
  function wireTrendsUI(){
    document.querySelectorAll('#view-trends .tseg button').forEach(b=>{
      b.onclick = ()=>{
        document.querySelectorAll('#view-trends .tseg button').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        ['chip','putt','ud'].forEach(t=>
          document.getElementById('tab-'+t).classList.toggle('hidden', b.dataset.tab !== t)
        );
      };
    });
    document.querySelectorAll('#lieChipsT .chip').forEach(c=>{
      c.onclick = ()=>{
        document.querySelectorAll('#lieChipsT .chip').forEach(x=>x.classList.remove('active'));
        c.classList.add('active'); chipLie = c.dataset.lie; renderChip();
      };
    });

    document.getElementById('exportAllCSV').onclick = ()=>{
      const rows = filteredHoles();
      const cols = [
        "sessionId","hole","date","lie","dist_yd",
        "chip_leave_ft","chip_depth_ft","chip_lateral_ft",
        "putt1_ft","putt1_depth_ft","putt1_lateral_ft",
        "putt2_ft","putt3_ft","score"
      ];
      const out = [cols];
      rows.forEach(r=>{
        out.push([
          r.sessionId||"", r.hole, formatMMDDYYYY(r.date), r.lie, r.dist,
          r.chipLeave, r.chipDepthSigned, r.chipLateralSigned,
          r.p1||"", r.p1DepthSigned||"", r.p1LateralSigned||"",
          r.p2||"", r.p3||"", r.score
        ]);
      });
      const csv = out.map(row => row.map(sanitizeCsvCell).join(",")).join("\n");
      const blob = new Blob(["\ufeff"+csv],{type:"text/csv;charset=utf-8;"});
      // keep the old anchor method here too
      downloadViaAnchor('par2_trends.csv', blob);
    };

    document.getElementById('exportJSONTrends').onclick = async ()=>{
      try{
        const sessions = await idbAll('sessions').catch(()=>[]);
        const holes    = await idbAll('holes').catch(()=>[]);
        const backup = {
          v: 1,
          exportedAt: new Date().toISOString(),
          editor: { date: dateInput.value || todayLocalISO(), hole: parseInt(holeInput.value||'1',10), rows: saved },
          sessions, holes
        };

        // Filename: "Par2 MM-DD-YYYY.json"
        const fname = `Par2 ${formatMMDDYYYY(todayLocalISO())}.json`;
        const blob = new Blob([JSON.stringify(backup,null,2)], {type:'application/json'});
        downloadJSONSmart(fname, blob);
      }catch(e){
        console.error(e); alert('Could not create backup JSON.');
      }
    };

    document.getElementById('importJSONInput').addEventListener('change', async (e)=>{
      const file = e.target.files && e.target.files[0];
      e.target.value = '';
      if (!file) return;
      try{
        const text = await file.text();
        const data = JSON.parse(text);
        const sessions = Array.isArray(data.sessions) ? data.sessions : [];
        const holes = Array.isArray(data.holes) ? data.holes : [];
        const editorRows = data.editor && Array.isArray(data.editor.rows) ? data.editor.rows : [];

        const replace = confirm('Import mode:\nOK = Replace existing data\nCancel = Merge into current data');
        if (replace){
          await idbDeleteWholeDB();
          await openPar2DB();
        }

        const existing = replace ? [] : await idbAll('sessions');
        const existingIds = new Set(existing.map(s=>s.id));
        const idMap = new Map();
        const rand = () => Math.random().toString(36).slice(2,7);

        const db = await openPar2DB();
        const tx = db.transaction(['sessions','holes'], 'readwrite');
        const stS = tx.objectStore('sessions');
        const stH = tx.objectStore('holes');

        for (const s of sessions){
          let id = s.id || `s_${Date.now()}_${rand()}`;
          if (!replace && existingIds.has(id)){ const nid = `s_${Date.now()}_${rand()}`; idMap.set(id,nid); id = nid; }
          else { idMap.set(id,id); }
          stS.put({ ...s, id });
        }
        for (const h of holes){
          const {uid, ...rest} = h;
          const sid = idMap.get(h.sessionId) || h.sessionId;
          stH.add({ ...rest, sessionId:sid });
        }

        tx.oncomplete = ()=> db.close();

        if (editorRows.length){ saved = editorRows; renderLog(); }

        [SESSIONS, HOLES] = await Promise.all([idbAll('sessions'), idbAll('holes')]);
        currentSession = '';
        populateSessionPicker();
        renderTrendsAll();

        alert(`Imported ${sessions.length} session(s) and ${holes.length} hole(s).`);
      }catch(err){
        console.error(err);
        alert('Import failed. Make sure this is a valid Par2 backup JSON.');
      }
    });

    document.getElementById('openInEditor').onclick = async ()=>{
      const id = document.getElementById('sessionPick').value;
      if (!id){ showView('editor'); return; }
      try{
        const rows = await idbGetHolesBySession(id);
        saved = rows
          .sort((a,b)=> (Number(a.hole)||0) - (Number(b.hole)||0))
          .map(({uid,sessionId, ...r})=> ({...r}));
        workingSessionId = id;
        renderLog();
        document.getElementById('hole').value = 1;
        updateSaveLabel();
        showView('editor');
        setTimeout(()=> { onHoleChange(); window.scrollTo({top:0,behavior:'smooth'}); }, 0);
        updateSessionHeader();
      }catch(e){
        console.error(e);
        alert('Could not open session.');
      }
    };

    document.getElementById('deleteSessionBtn').onclick = async ()=>{
      const id = document.getElementById('sessionPick').value;
      if (!id) return;
      if (!confirm('Delete this session? This cannot be undone.')) return;
      try{
        await idbDeleteSession(id);
        if (workingSessionId === id){
          workingSessionId = '';
          saved = [];
          renderLog();
          document.getElementById('hole').value = 1;
          updateSaveLabel();
          clearUISelections();
          updateSessionHeader();
        }
        [SESSIONS, HOLES] = await Promise.all([idbAll('sessions'), idbAll('holes')]);
        currentSession = '';
        populateSessionPicker();
        renderTrendsAll();
        alert('Session deleted.');
      }catch(e){
        console.error(e);
        alert('Could not delete session.');
      }
    };
  }

  // ===== Initial boot =====
  document.querySelectorAll("#lieChips .pill").forEach(x=>x.classList.remove("active"));
  document.getElementById("chipSection").classList.add("hidden");
  document.getElementById("sectionP1").classList.add("hidden");
  document.getElementById("sectionP23").classList.add("hidden");
  renderFilterRow(); calcAll(); renderLog();
  updateSessionHeader();
  showView('home'); // start at landing

  // wire trends once when first opened
  function wireTrendsUIOnce(){ if (!wireTrendsUI._wired){ wireTrendsUI(); wireTrendsUI._wired=true; } }
  document.getElementById('goTrendsBtn').addEventListener('click', wireTrendsUIOnce, {once:true});
  document.getElementById('homeTrendsBtn').addEventListener('click', wireTrendsUIOnce, {once:true});
</script>
</body>
</html>