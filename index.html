<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Par2</title>
<style>
  :root { --bg:#0f1115; --panel:#1a1f24; --panel-2:#11161b; --text:#e8ecf1;
    --muted:#9aa7b2; --accent:#2ea043; --btn:#2b3138; --btn-active:#355043;
    --border:#2a3138; --radius:14px; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,Inter,Arial,sans-serif}
  .wrap{max-width:420px;margin:0 auto;padding:12px}
  header{display:flex;gap:8px;padding:10px;border-bottom:1px solid var(--border);
    position:sticky;top:0;background:rgba(15,17,21,.95);backdrop-filter:blur(8px);z-index:4}
  .btn{background:var(--btn);color:var(--text);border:1px solid var(--border);
    padding:8px 12px;border-radius:10px;cursor:pointer}
  .save{background:var(--accent);border:none;color:#08130a;font-weight:700}
  h2{margin:0 0 8px 0;font-size:14px;color:var(--muted);font-weight:600}
  .panel{background:var(--panel);padding:12px;margin:10px 0;border-radius:var(--radius);
    border:1px solid var(--border)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .field{display:grid;gap:6px}
  .input,.counter,.pill{background:var(--panel-2);border:1px solid var(--border);border-radius:12px;
    padding:10px 12px;color:var(--text);display:inline-flex;align-items:center;justify-content:center}
  .input input{background:transparent;border:none;outline:none;color:var(--text);width:100%;font-size:16px}
  .counter{gap:8px}
  .counter button{width:36px;height:36px;background:var(--btn);color:var(--text);
    border:1px solid var(--border);border-radius:10px}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .pill{padding:10px 12px;border-radius:10px;cursor:pointer}
  .pill.active{outline:2px solid var(--accent)}
  #distanceGrid{display:grid;grid-template-columns:repeat(6,1fr);gap:6px}
  #distanceGrid button{background:var(--btn);color:var(--text);border:1px solid var(--border);
    padding:6px;border-radius:9px;min-height:34px;font-size:13px}
  #distanceGrid button.active{background:var(--btn-active);border-color:#3f6f5d}
  .stack{display:grid;gap:8px}
  .subtle{color:var(--muted);font-size:12px}
  .pad{display:grid;grid-template-columns:auto 1fr;gap:8px;align-items:center}
  .pad .options{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
  .pad .options button{background:var(--btn);color:var(--text);border:1px solid var(--border);
    padding:8px 10px;border-radius:10px;cursor:pointer}
  .pad .options button.active{background:var(--btn-active);border-color:#3f6f5d}

  /* Footer buttons */
  .footer{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center}
  .footer .save {padding:12px 18px; font-size:16px; border-radius:12px; min-width:130px;}
  .footer .undo {padding:8px 12px; font-size:13px; border-radius:10px; opacity:.95;}
  .footer .spacer {height:1px;}

  table{width:100%;border-collapse:collapse;font-size:12px}
  th,td{padding:10px 8px;border-bottom:1px solid var(--border);text-align:left;color:var(--text)}
  th{color:var(--muted);font-weight:600}
  .tight th,.tight td{padding:8px}
  .hidden{display:none}

  /* Segmented toggle */
  .seg {display:inline-flex; border:1px solid var(--border); border-radius:10px; overflow:hidden}
  .seg button{background:var(--panel-2); color:var(--text); padding:6px 10px; border:none; cursor:pointer}
  .seg button.active{background:var(--btn-active)}

  /* Dispersion + filter row (legend + filter in one) */
  canvas{display:block; width:100%; height:auto; max-width:380px; border-radius:10px; background:#101419}
  .filterbar { margin-top:8px; display:flex; gap:8px; flex-wrap:wrap }
  .flt { padding:4px 8px; border-radius:10px; border:1px solid var(--border); user-select:none; cursor:pointer }
  .flt.off { filter: grayscale(1); opacity:.45; }
  .flt-fairway { color:#7CFC00; border-color:#375b37 }
  .flt-rough   { color:#ffa74d; border-color:#6f5131 }
  .flt-green   { color:#5ee0ff; border-color:#2b4c57 }
  .flt-recovery{ color:#ff5a5a; border-color:#633138 }
  .flt-d1 { color:#9cdcfe; border-color:#395268 }    /* 10–25 yd */
  .flt-d2 { color:#a6e22e; border-color:#3b5b2b }    /* 30–45 yd */
  .flt-d3 { color:#ffb454; border-color:#6a4c22 }    /* 50–65 yd */
</style>
</head>
<body>
<header class="wrap">
  <button class="btn" id="exportBtn">Export</button>
  <button class="btn" id="todayBtn">Today</button>
  <button class="btn" id="clearBtn">Clear</button>
</header>

<main class="wrap" id="topOfApp">
  <section class="panel">
    <div class="row">
      <div class="field">
        <h2>Hole</h2>
        <div class="counter">
          <button id="holeMinus">−</button>
          <div class="input"><input id="hole" type="number" min="1" value="1" /></div>
          <button id="holePlus">+</button>
        </div>
      </div>
      <div class="field">
        <h2>Date</h2>
        <div class="input"><input id="date" type="date" /></div>
      </div>
    </div>
  </section>

  <section class="panel">
    <h2>Distance (yds)</h2>
    <div id="distanceGrid">
      <button>10</button><button>15</button><button>20</button><button>25</button><button>30</button><button>35</button>
      <button>40</button><button>45</button><button>50</button><button>55</button><button>60</button><button>65</button>
    </div>
  </section>

  <section class="panel">
    <h2>Lie</h2>
    <div class="chips" id="lieChips">
      <div class="pill" data-lie="Rough">Rough</div>
      <div class="pill" data-lie="Fairway">Fairway</div>
      <div class="pill" data-lie="Green">Green</div>
      <div class="pill" data-lie="Recovery">Recovery</div>
    </div>
  </section>

  <!-- Chip result pads -->
  <section class="panel">
    <h2>Chip Result (Direction Pad)</h2>
    <div class="stack">
      <div class="pad">
        <div class="subtle">Depth</div>
        <div class="options" id="depthOptionsChip">
          <button data-depth="short">Short</button>
          <button class="active" data-depth="exact">Exact</button>
          <button data-depth="long">Long</button>
          <div class="input" style="width:70px;margin-left:8px;"><input id="depthFtChip" type="number" min="0" step="1" placeholder="ft" /></div>
        </div>
      </div>
      <div class="pad">
        <div class="subtle">Line</div>
        <div class="options" id="lineOptionsChip">
          <button data-line="left">Left</button>
          <button class="active" data-line="straight">Straight</button>
          <button data-line="right">Right</button>
          <div class="input" style="width:70px;margin-left:8px;"><input id="lineFtChip" type="number" min="0" step="1" placeholder="ft" /></div>
        </div>
      </div>
      <div class="subtle" id="derivedChip">Derived leave: —</div>
    </div>
  </section>

  <!-- Putt 1 with direction -->
  <section class="panel" id="sectionP1">
    <h2>Putt 1</h2>
    <div class="stack">
      <div class="field">
        <div class="subtle">Distance before Putt 1 (ft)</div>
        <div class="input"><input id="putt1Dist" type="number" min="0" step="1" placeholder="0" /></div>
      </div>
      <div class="pad">
        <div class="subtle">Depth</div>
        <div class="options" id="depthOptionsP1">
          <button data-depth="short">Short</button>
          <button class="active" data-depth="exact">Exact</button>
          <button data-depth="long">Long</button>
          <div class="input" style="width:70px;margin-left:8px;"><input id="depthFtP1" type="number" min="0" step="1" placeholder="ft" /></div>
        </div>
      </div>
      <div class="pad">
        <div class="subtle">Line</div>
        <div class="options" id="lineOptionsP1">
          <button data-line="left">Left</button>
          <button class="active" data-line="straight">Straight</button>
          <button data-line="right">Right</button>
          <div class="input" style="width:70px;margin-left:8px;"><input id="lineFtP1" type="number" min="0" step="1" placeholder="ft" /></div>
        </div>
      </div>
      <div class="subtle" id="derivedP1">Derived leave after P1: —</div>
    </div>
  </section>

  <!-- Putts 2 & 3 only -->
  <section class="panel" id="sectionP23">
    <h2>Putts 2 & 3 (distances only)</h2>
    <div class="row">
      <div class="field">
        <div class="subtle">Putt 2 (ft)</div>
        <div class="input"><input id="putt2" type="number" min="0" step="1" placeholder="0" /></div>
      </div>
      <div class="field">
        <div class="subtle">Putt 3 (ft)</div>
        <div class="input"><input id="putt3" type="number" min="0" step="1" placeholder="0" /></div>
      </div>
    </div>
  </section>

  <!-- Save / Undo -->
  <section class="panel footer">
    <button class="btn save" id="saveBtn">Save Hole</button>
    <div class="spacer"></div>
    <button class="btn undo" id="undoBtn">Undo</button>
    <div style="grid-column: 1 / -1; margin-top:8px;"><strong>Score (auto):</strong> <span id="score">—</span></div>
  </section>

  <!-- Summary -->
  <section class="panel">
    <div id="summaryBar" style="font-weight:600;">
      Par: 0 | Total: 0 | Up/Down %: 0% | Over Par: 0
    </div>
  </section>

  <!-- Log table -->
  <section class="panel">
    <table class="tight">
      <thead>
        <tr>
          <th>#</th><th>Date</th><th>Lie</th><th>Dist</th>
          <th>Putt 1</th><th>Putt 2</th><th>Putt 3</th><th>Score</th>
        </tr>
      </thead>
      <tbody id="logBody"></tbody>
    </table>
  </section>

  <!-- Session dispersion chart + color toggle + SINGLE dynamic filter row -->
  <section class="panel">
    <h2 style="display:flex;justify-content:space-between;align-items:center;">
      <span>Session Dispersion (ft)</span>
      <span class="seg" id="colorModeSeg">
        <button data-mode="lie" class="active">Lie</button>
        <button data-mode="distance">Distance</button>
      </span>
    </h2>
    <canvas id="chipChart" width="380" height="280"></canvas>
    <div class="filterbar subtle" id="dynFilterRow"></div>
    <div class="subtle" style="margin-top:6px;">x = Left(−) / Right(+), y = Short(−) / Long(+)</div>
  </section>
</main>

<script>
  const r0 = (n) => Math.round(Number(n) || 0);

  let selectedDist = null, selectedLie = "", saved = [];
  let colorMode = "lie";                        // "lie" | "distance"
  const activeCats = {                          // active filters for both modes
    Fairway:true, Rough:true, Green:true, Recovery:true,
    d1:true, d2:true, d3:true
  };
  const includeChipInsInUpDown = true;

  // Hole/date
  const holeInput = document.getElementById("hole");
  document.getElementById("holeMinus").onclick = () => { holeInput.value = Math.max(1, parseInt(holeInput.value||"1")-1); };
  document.getElementById("holePlus").onclick  = () => { holeInput.value = parseInt(holeInput.value||"1")+1; };
  document.getElementById("todayBtn").onclick  = () => { document.getElementById("date").value = new Date().toISOString().slice(0,10); };
  document.getElementById("date").value = new Date().toISOString().slice(0,10);

  // Distance
  document.querySelectorAll("#distanceGrid button").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      document.querySelectorAll("#distanceGrid button").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      selectedDist = parseInt(btn.textContent,10);
      calcAll();
    });
  });

  // Lie
  document.querySelectorAll("#lieChips .pill").forEach(p=>{
    p.addEventListener("click", ()=>{
      document.querySelectorAll("#lieChips .pill").forEach(x=>x.classList.remove("active"));
      p.classList.add("active");
      selectedLie = p.dataset.lie;
      calcAll();
    });
  });

  let chipDepth="exact", chipLine="straight", p1Depth="exact", p1Line="straight";
  function setActive(groupSel, attr, value){
    document.querySelectorAll(groupSel+" button["+attr+"]")
      .forEach(b=>b.classList.toggle("active", b.getAttribute(attr)===value));
  }
  document.querySelectorAll("#depthOptionsChip button[data-depth]").forEach(b=>b.onclick=()=>{ chipDepth=b.dataset.depth; setActive("#depthOptionsChip","data-depth",chipDepth); calcAll(); });
  document.querySelectorAll("#lineOptionsChip button[data-line]").forEach(b=>b.onclick=()=>{ chipLine=b.dataset.line; setActive("#lineOptionsChip","data-line",chipLine); calcAll(); });
  document.querySelectorAll("#depthOptionsP1 button[data-depth]").forEach(b=>b.onclick=()=>{ p1Depth=b.dataset.depth; setActive("#depthOptionsP1","data-depth",p1Depth); calcAll(); });
  document.querySelectorAll("#lineOptionsP1 button[data-line]").forEach(b=>b.onclick=()=>{ p1Line=b.dataset.line; setActive("#lineOptionsP1","data-line",p1Line); calcAll(); });

  const depthFtChip = document.getElementById("depthFtChip");
  const lineFtChip  = document.getElementById("lineFtChip");
  const putt1Dist   = document.getElementById("putt1Dist");
  const depthFtP1   = document.getElementById("depthFtP1");
  const lineFtP1    = document.getElementById("lineFtP1");
  const p2          = document.getElementById("putt2");
  const p3          = document.getElementById("putt3");
  const derivedChip = document.getElementById("derivedChip");
  const derivedP1   = document.getElementById("derivedP1");
  const scoreEl     = document.getElementById("score");

  ["depthFtChip","lineFtChip","putt1Dist","depthFtP1","lineFtP1","putt2","putt3"].forEach(id=>{
    const el = document.getElementById(id);
    el.addEventListener("change", () => { el.value = el.value === "" ? "" : r0(el.value); calcAll(); });
    el.addEventListener("input", calcAll);
  });

  function leaveFromPad(depthMode, lineMode, d, l) {
    const D = r0(d), L = r0(l);
    const dSigned = depthMode === "short" ? -D : depthMode === "long" ? +D : 0;
    const lSigned = lineMode  === "left"  ? -L : lineMode  === "right"? +L : 0;
    const leave   = Math.sqrt(D*D + L*L);
    return {
      leave:     r0(leave),
      dSigned:   r0(dSigned),
      lSigned:   r0(lSigned),
      depthDir:  dSigned < 0 ? "Short" : dSigned > 0 ? "Long" : "Exact",
      lineDir:   lSigned < 0 ? "Left"  : lSigned > 0 ? "Right" : "Straight"
    };
  }

  function maybeShowP1(){
    const showP1 = r0(putt1Dist.value) > 0 || r0(depthFtP1.value) > 0 || r0(lineFtP1.value) > 0;
    document.getElementById("sectionP1").classList.toggle("hidden", !showP1);
    const show23 = r0(putt1Dist.value) > 0;
    document.getElementById("sectionP23").classList.toggle("hidden", !show23);
  }

  function calcAll(){
    const chip = leaveFromPad(chipDepth, chipLine, depthFtChip.value, lineFtChip.value);
    derivedChip.textContent = chip.leave>0
      ? `Derived leave: ${chip.leave} ft (${chip.depthDir} ${Math.abs(chip.dSigned)} / ${chip.lineDir} ${Math.abs(chip.lSigned)})`
      : "Derived leave: —";
    putt1Dist.value = chip.leave > 0 ? chip.leave : "";

    const p1leave = leaveFromPad(p1Depth, p1Line, depthFtP1.value, lineFtP1.value);
    derivedP1.textContent = (depthFtP1.value || lineFtP1.value)
      ? `Derived leave after P1: ${p1leave.leave} ft (${p1leave.depthDir} ${Math.abs(p1leave.dSigned)} / ${p1leave.lineDir} ${Math.abs(p1leave.lSigned)})`
      : "Derived leave after P1: —";

    if (r0(putt1Dist.value) > 0) { p2.value = p1leave.leave > 0 ? p1leave.leave : ""; } else { p2.value = ""; }

    const offGreen = (selectedLie !== "Green");
    let strokes = offGreen ? 1 : 0, putts = 0;
    if (r0(putt1Dist.value) > 0) putts++;
    if (r0(p2.value) > 0) putts++;
    if (r0(p3.value) > 0) putts++;
    strokes += putts;
    if (offGreen && chip.leave===0 && putts===0) strokes = 1;
    scoreEl.textContent = (!selectedDist || !selectedLie) ? "—" : strokes;

    if (chip.leave>0) document.getElementById("sectionP1").classList.remove("hidden");
    maybeShowP1();
  }

  function clearActivePills(){
    ["#depthOptionsChip button","#lineOptionsChip button",
     "#depthOptionsP1 button","#lineOptionsP1 button"]
     .forEach(sel => document.querySelectorAll(sel).forEach(b=>b.classList.remove("active")));
    chipDepth=""; chipLine=""; p1Depth=""; p1Line="";
  }
  function hidePuttSections(){
    document.getElementById("sectionP1").classList.add("hidden");
    document.getElementById("sectionP23").classList.add("hidden");
    putt1Dist.value=""; depthFtP1.value=""; lineFtP1.value="";
    p2.value=""; p3.value="";
    derivedP1.textContent = "Derived leave after P1: —";
  }

  function renderLog(){
    const tbody = document.getElementById("logBody");
    tbody.innerHTML = "";
    saved.forEach(r=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.hole}</td><td>${r.date}</td><td>${r.lie}</td><td>${r.dist} yd</td>
        <td>${r.p1 || ""}${r.p1? " ft": ""}</td>
        <td>${r.p2 || ""}${r.p2? " ft": ""}</td>
        <td>${r.p3 || ""}${r.p3? " ft": ""}</td>
        <td>${r.score}</td>`;
      tbody.appendChild(tr);
    });

    const holes = saved.length;
    const par   = holes * 2;
    const total = saved.reduce((s,r)=>s + (Number(r.score)||0), 0);
    const attempts = saved.filter(r => (r.lie !== "Green")).length;
    const successes = saved.filter(r => (r.lie !== "Green") && (includeChipInsInUpDown ? r.score <= 2 : r.score === 2)).length;
    const updownPct = attempts ? Math.round((successes/attempts)*100) : 0;
    const over = total - par;
    const overLabel = over > 0 ? `+${over}` : `${over}`;
    document.getElementById("summaryBar").textContent =
      `Par: ${par} | Total: ${total} | Up/Down %: ${updownPct}% | Over Par: ${overLabel}`;

    renderFilterRow();
    renderChart();
  }

  document.getElementById("saveBtn").addEventListener("click", () => {
    const hole = parseInt(holeInput.value||"1");
    const date = document.getElementById("date").value || new Date().toISOString().slice(0,10);

    const chip = leaveFromPad(chipDepth || "exact", chipLine || "straight", depthFtChip.value, lineFtChip.value);
    const p1   = leaveFromPad(p1Depth   || "exact", p1Line   || "straight", depthFtP1.value,  lineFtP1.value);

    const offGreen = (selectedLie !== "Green");
    let strokes = offGreen ? 1 : 0, putts = 0;
    const p1d = r0(putt1Dist.value); if (p1d>0) putts++;
    const p2d = r0(p2.value);       if (p2d>0) putts++;
    const p3d = r0(p3.value);       if (p3d>0) putts++;
    strokes += putts;
    if (offGreen && chip.leave===0 && putts===0) strokes = 1;

    const row = {
      hole, date, lie: selectedLie || "", dist: selectedDist ?? "",
      chipLeave: chip.leave, chipDepthSigned: chip.dSigned, chipLateralSigned: chip.lSigned,
      chipDepthDir: chip.depthDir, chipLineDir: chip.lineDir,
      chipX: chip.lSigned, chipY: chip.dSigned,
      p1: p1d || "", p1DepthSigned: p1.dSigned || "", p1LateralSigned: p1.lSigned || "",
      p1DepthDir: p1.depthDir || "", p1LineDir: p1.lineDir || "",
      p2: p2d || "", p3: p3d || "", score: strokes
    };
    saved.push(row);
    renderLog();

    // Reset + scroll top
    holeInput.value = hole + 1;
    document.querySelectorAll("#distanceGrid button").forEach(b=>b.classList.remove("active")); selectedDist=null;
    document.querySelectorAll("#lieChips .pill").forEach(x=>x.classList.remove("active")); selectedLie = "";
    depthFtChip.value=""; lineFtChip.value=""; clearActivePills(); hidePuttSections(); calcAll();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  document.getElementById("undoBtn").addEventListener("click", () => {
    if (!saved.length) return;
    saved.pop();
    holeInput.value = Math.max(1, saved.length + 1);
    renderLog();
  });

  document.getElementById("exportBtn").addEventListener("click", () => {
    const cols = [
      "hole","date","lie","dist_yd",
      "chip_leave_ft","chip_depth_ft_signed","chip_lateral_ft_signed","chip_depth_dir","chip_line_dir",
      "putt1_ft","putt1_depth_ft_signed","putt1_lateral_ft_signed","putt1_depth_dir","putt1_line_dir",
      "putt2_ft","putt3_ft","score"
    ];
    const rows = [cols];
    saved.forEach(r=>{
      rows.push([
        r.hole, r.date, r.lie, r.dist,
        r.chipLeave, r.chipDepthSigned, r.chipLateralSigned, r.chipDepthDir, r.chipLineDir,
        r.p1 || "", r.p1DepthSigned || "", r.p1LateralSigned || "", r.p1DepthDir || "", r.p1LineDir || "",
        r.p2 || "", r.p3 || "", r.score
      ]);
    });
    const csv = rows.map(a=>a.join(",")).join("\n");
    const blob = new Blob([csv],{type:"text/csv;charset=utf-8;"});
    const a = document.createElement("a"); a.href = URL.createObjectURL(blob);
    a.download = "par2_export.csv"; a.click();
  });

  document.getElementById("clearBtn").addEventListener("click", () => {
    saved = []; holeInput.value = 1; renderLog();
  });

  // Color toggle
  document.querySelectorAll('#colorModeSeg button').forEach(b=>{
    b.addEventListener('click', ()=>{
      document.querySelectorAll('#colorModeSeg button').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      colorMode = b.dataset.mode;
      renderFilterRow();
      renderChart();
    });
  });

  // ---- Dynamic filter row (legend + filter in one) ----
  function renderFilterRow(){
    const row = document.getElementById('dynFilterRow');
    row.innerHTML = "";
    if (colorMode === "lie"){
      ["Fairway","Rough","Green","Recovery"].forEach(k=>{
        const span = document.createElement('span');
        span.className = `flt flt-${k.toLowerCase()} ${activeCats[k] ? "" : "off"}`;
        span.textContent = k;
        span.onclick = ()=>{ activeCats[k] = !activeCats[k]; span.classList.toggle('off', !activeCats[k]); renderChart(); };
        row.appendChild(span);
      });
    } else {
      const cats = [
        {k:"d1", label:"10–25 yd"},
        {k:"d2", label:"30–45 yd"},
        {k:"d3", label:"50–65 yd"},
      ];
      cats.forEach(({k,label})=>{
        const span = document.createElement('span');
        span.className = `flt flt-${k} ${activeCats[k] ? "" : "off"}`;
        span.textContent = label;
        span.onclick = ()=>{ activeCats[k] = !activeCats[k]; span.classList.toggle('off', !activeCats[k]); renderChart(); };
        row.appendChild(span);
      });
    }
  }

  function bucketForDistance(d){
    d = Number(d)||0;
    if (d>=10 && d<=25) return 'd1';
    if (d>=30 && d<=45) return 'd2';
    if (d>=50 && d<=65) return 'd3';
    return 'd1';
  }
  function colorFor(row){
    if (colorMode === 'lie'){
      switch((row.lie||"").toLowerCase()){
        case "fairway":  return "#7CFC00";
        case "rough":    return "#ffa74d";
        case "green":    return "#5ee0ff";
        case "recovery": return "#ff5a5a";
        default:         return "#e8ecf1";
      }
    } else {
      const b = bucketForDistance(row.dist);
      return (b==='d1') ? "#9cdcfe" : (b==='d2') ? "#a6e22e" : "#ffb454";
    }
  }

  function renderChart(){
    const cv = document.getElementById('chipChart'); if (!cv) return;
    const ctx = cv.getContext('2d'); const W=cv.width, H=cv.height;
    ctx.clearRect(0,0,W,H);

    // Apply current filters
    const pts = saved.filter(r=>{
      if (colorMode === "lie") return activeCats[r.lie ?? ""] === true;
      const b = bucketForDistance(r.dist);
      return activeCats[b] === true;
    }).map(r => ({x:r.chipX, y:r.chipY, c:colorFor(r)}));

    const maxAbs = Math.max(5, ...pts.map(p => Math.max(Math.abs(p.x), Math.abs(p.y))), 5);
    const pad = 10, scale = (Math.min(W,H)/2 - pad) / (maxAbs || 5);
    const cx=W/2, cy=H/2;

    ctx.strokeStyle = '#2a3138'; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(0,cy); ctx.lineTo(W,cy); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(cx,0); ctx.lineTo(cx,H); ctx.stroke();

    ctx.fillStyle = '#9aa7b2'; ctx.font='11px system-ui';
    for (let t=-maxAbs; t<=maxAbs; t+=5){
      const x = cx + t*scale, y = cy - t*scale;
      ctx.strokeStyle='#2a3138';
      ctx.beginPath(); ctx.moveTo(x,cy-3); ctx.lineTo(x,cy+3); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(cx-3,y); ctx.lineTo(cx+3,y); ctx.stroke();
      if (t!==0){ ctx.fillText(String(t), x-6, cy+14); ctx.fillText(String(t), cx+6, y+3); }
    }

    let mx=0,my=0,r=0;
    if (pts.length){
      mx = pts.reduce((s,p)=>s+p.x,0)/pts.length;
      my = pts.reduce((s,p)=>s+p.y,0)/pts.length;
      r  = Math.sqrt(pts.reduce((s,p)=>s+(p.x-mx)*(p.x-mx)+(p.y-my)*(p.y-my),0)/pts.length);
    }
    ctx.strokeStyle='#2ea043'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.arc(cx + mx*scale, cy - my*scale, r*scale, 0, Math.PI*2); ctx.stroke();
    ctx.fillStyle='#2ea043'; ctx.beginPath(); ctx.arc(cx + mx*scale, cy - my*scale, 3, 0, Math.PI*2); ctx.fill();

    pts.forEach(p=>{
      ctx.beginPath(); ctx.arc(cx + p.x*scale, cy - p.y*scale, 2.8, 0, Math.PI*2);
      ctx.fillStyle=p.c; ctx.fill(); ctx.lineWidth=.8; ctx.strokeStyle='rgba(255,255,255,.9)'; ctx.stroke();
    });
  }

  // init
  document.querySelectorAll("#lieChips .pill").forEach(x=>x.classList.remove("active"));
  document.getElementById("sectionP1").classList.add("hidden");
  document.getElementById("sectionP23").classList.add("hidden");
  renderFilterRow(); calcAll(); renderLog();
</script>
</body>
</html>
