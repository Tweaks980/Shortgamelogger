<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Par2</title>
<style>
  :root { --bg:#0f1115; --panel:#1a1f24; --panel-2:#11161b; --text:#e8ecf1;
    --muted:#9aa7b2; --accent:#2ea043; --accent-2:#3b82f6; --btn:#2b3138; --btn-active:#355043;
    --border:#2a3138; --radius:14px; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,Inter,Arial,sans-serif}
  .wrap{max-width:420px;margin:0 auto;padding:12px}

  header{display:flex;gap:8px;padding:10px;border-bottom:1px solid var(--border);
    position:sticky;top:0;background:rgba(15,17,21,.95);backdrop-filter:blur(8px);z-index:4}
  .btn{background:var(--btn);color:var(--text);border:1px solid var(--border);
    padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn:focus{outline:2px solid #5a9; outline-offset:2px}
  .save{background:var(--accent);border:none;color:#08130a;font-weight:700}
  .btn.full{width:100%; justify-content:center}
  .btn.chartToggle{background:var(--accent-2); color:#fff; border:none; font-weight:800;
    padding:14px 18px; border-radius:14px; font-size:16px}

  h2{margin:0 0 8px 0;font-size:14px;color:var(--muted);font-weight:600}
  .h2-center-white{color:var(--text); text-align:center;}
  .h2-strong-left{color:var(--text)}

  /* helper bubble */
  .helpwrap{position:relative; display:flex; justify-content:center; align-items:center;}
  .helpbtn{cursor:help}
  .tip{position:absolute; top:100%; left:50%; transform:translateX(-50%);
    background:var(--panel-2); border:1px solid var(--border); color:var(--text);
    padding:10px 12px; border-radius:10px; font-size:13px; width:min(320px,90vw);
    margin-top:6px; display:none; z-index:5}
  .helpwrap.open .tip{ display:block; }

  .panel{background:var(--panel);padding:12px;margin:10px 0;border-radius:var(--radius);
    border:1px solid var(--border)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row.divider-2cols{grid-template-columns:minmax(0,1fr) 1px minmax(0,1fr);align-items:start}
  .vdiv{width:1px;background:var(--border);height:100%;border-radius:1px}
  .field{display:grid;gap:6px}

  .input,.counter,.pill{background:var(--panel-2);border:1px solid var(--border);border-radius:12px;
    padding:10px 12px;color:var(--text);display:inline-flex;align-items:center;justify-content:center}
  .input input{background:transparent;border:none;outline:none;color:var(--text);width:100%;font-size:16px}
  .input.slim{padding:8px 10px; min-width:84px}
  .input.datepill{height:36px; padding:8px 12px; border-radius:12px; width:100%}
  .input.datepill input{appearance:none}
  .input.slim.p1{padding:4px 10px; min-width:0; border-radius:10px; width:auto}
  .inlinePuttRow { display:flex; align-items:center; gap:8px; margin:4px 0 14px 0; justify-content:center; }
  .inlinePuttRow .p1 input{ width:5ch; text-align:center; font-variant-numeric:tabular-nums; }
  .counter{gap:8px}
  .counter button{width:36px;height:36px;background:var(--btn);color:var(--text);
    border:1px solid var(--border);border-radius:10px}

  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .pill{padding:10px 12px;border-radius:10px;cursor:pointer; color:var(--muted); border-color:var(--border)}
  .pill.active{outline:2px solid var(--accent)}
  /* Lie colors when active */
  .pill[data-lie="Fairway"].active  { color:#7CFC00; border-color:#375b37; outline-color:#7CFC00 }
  .pill[data-lie="Rough"].active    { color:#ffa74d; border-color:#6f5131; outline-color:#ffa74d }
  .pill[data-lie="Sand"].active     { color:#e8d27c; border-color:#6a5b2e; outline-color:#e8d27c }
  .pill[data-lie="Recovery"].active { color:#ff5a5a; border-color:#633138; outline-color:#ff5a5a }

  #distanceGrid{display:grid;grid-template-columns:repeat(6,1fr);gap:6px}
  #distanceGrid button{background:var(--btn);color:var(--text);border:1px solid var(--border);
    padding:6px;border-radius:9px;min-height:34px;font-size:13px}
  /* Tight outline like Lie pills */
  #distanceGrid button.active{background:var(--btn-active);border-color:#3f6f5d;outline:2px solid var(--accent); outline-offset:1px}

  .stack{display:grid;gap:8px}
  .subtle{color:var(--muted);font-size:12px}
  .subNote{ font-size:11px; font-style:italic; opacity:.9; margin-left:4px; }

  /* Steppers */
  .stepper { display:grid; grid-template-columns:36px minmax(0,1fr) 36px; gap:8px; align-items:center; }
  .stepper .step { width:36px; height:36px; background:var(--btn); border:1px solid var(--border); border-radius:10px; font-size:16px; display:flex; align-items:center; justify-content:center; cursor:pointer; }
  .readout { display:flex; align-items:center; justify-content:center; gap:6px; font-weight:800; font-size:20px; }
  .readout input.readnum{ width:clamp(42px, 18vw, 70px); text-align:center; font-weight:800; font-size:20px; background:transparent; border:none; outline:none; color:var(--text); }
  .readout .unit { font-weight:600; font-size:14px; color:var(--text); opacity:.9 }
  .modeTag { display:inline-block; text-align:center; border-radius:999px; padding:6px 10px; border:1px solid var(--border); background:var(--panel-2); font-weight:600; font-size:13px; color:var(--text) }

  /* Micro labels over arrow buttons */
  .row.divider-2cols > .field{
    display:grid;
    grid-template-columns:36px minmax(0,1fr) 36px;
    grid-template-rows:auto auto auto;
    gap:6px 8px; align-items:center;
  }
  .microlabel{font-size:11px; color:var(--muted); justify-self:center; align-self:end}
  .ml-left { grid-column:1; grid-row:1; }
  .ml-right{ grid-column:3; grid-row:1; }
  .row.divider-2cols > .field > .stepper{grid-column:1 / -1;grid-row:2}
  .row.divider-2cols > .field > .modeTag{grid-column:2;grid-row:3;justify-self:center}

  /* Tiny cap hint */
  .capHint{font-size:11px; color:var(--muted); text-align:center; opacity:0; transition:opacity .15s; height:0; overflow:hidden}
  .capHint.show{opacity:1; height:auto; margin-top:4px}

  /* Footer buttons */
  .footer{display:grid;grid-template-columns:auto auto 1fr auto;gap:10px;align-items:center}
  .footer .save {padding:12px 18px; font-size:16px; border-radius:12px; min-width:130px;}
  .footer .scoreline{font-weight:600}
  .footer .undo {padding:8px 12px; font-size:13px; border-radius:10px; opacity:.95;}

  table{width:100%;border-collapse:collapse;font-size:12px}
  th,td{padding:10px 8px;border-bottom:1px solid var(--border);text-align:left;color:var(--text)}
  th{color:#fff;font-weight:600}
  .tight th,.tight td{padding:8px}
  .hidden{display:none}
  .score-cell{white-space:nowrap}
  .rowbtn{background:var(--btn);border:1px solid var(--border);border-radius:6px;padding:0 4px;cursor:pointer;font-size:11px;line-height:1;margin-left:6px}

  /* No row tap-to-edit */
  tbody tr{cursor:default}

  /* Color toggle + filters */
  .seg {display:inline-flex; border:1px solid var(--border); border-radius:10px; overflow:hidden}
  .seg button{background:var(--panel-2); color:var(--text); padding:6px 10px; border:none; cursor:pointer}
  .seg button.active{background:var(--btn-active)}
  canvas{display:block; width:100%; height:auto; max-width:380px; border-radius:10px; background:#101419}
  .filterbar { margin-top:8px; display:flex; gap:8px; flex-wrap:wrap }
  .flt { display:inline-flex; align-items:center; padding:4px 8px; border-radius:10px; border:1px solid var(--border); user-select:none; cursor:pointer; background:transparent; }
  .flt.off { filter: grayscale(1); opacity:.45; }
  .flt-fairway { color:#7CFC00; border-color:#375b37 }
  .flt-rough   { color:#ffa74d; border-color:#6f5131 }
  .flt-sand    { color:#e8d27c; border-color:#6a5b2e }
  .flt-recovery{ color:#ff5a5a; border-color:#633138 }
  .flt-d1 { color:#9cdcfe; border-color:#395268 }
  .flt-d2 { color:#a6e22e; border-color:#3b5b2b }
  .flt-d3 { color:#ffb454; border-color:#6a4c22 }

  #summaryBarTop{font-weight:700;font-size:14px;text-align:center}

  /* Toast */
  .toast{position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
    background:rgba(30,35,40,.96); color:#fff; padding:10px 14px; border-radius:12px;
    border:1px solid var(--border); font-weight:700; font-size:14px; opacity:0;
    pointer-events:none; transition:opacity .18s, transform .18s; z-index:50}
  .toast.show{opacity:1; transform:translateX(-50%) translateY(-2px)}

  @media (max-width: 380px){
    .row.divider-2cols > .field{grid-template-columns:32px minmax(0,1fr) 32px;gap:6px}
    .stepper { grid-template-columns:32px minmax(0,1fr) 32px; gap:6px; }
    .stepper .step{ width:32px; height:32px }
    .readout input.readnum{ width:clamp(38px, 22vw, 56px); font-size:18px }
  }
</style>
</head>
<body>
<header class="wrap">
  <button class="btn" id="exportBtn">Export CSV</button>
  <button class="btn" id="clearBtn">Clear</button>
</header>

<section class="wrap panel"><div id="summaryBarTop">Par: 0 | Gross: 0 | Up/Down: 0% | To Par: 0</div></section>

<main class="wrap" id="topOfApp">
  <section class="panel">
    <div class="row">
      <div class="field">
        <h2 class="h2-center-white">Hole</h2>
        <div class="counter">
          <button id="holeMinus">âˆ’</button>
          <div class="input"><input id="hole" type="number" min="1" value="1" inputmode="numeric" /></div>
          <button id="holePlus">+</button>
        </div>
      </div>
      <div class="field">
        <h2 class="h2-center-white">Date</h2>
        <div class="input datepill"><input id="date" type="date" /></div>
      </div>
    </div>
  </section>

  <section class="panel">
    <h2 class="h2-center-white">Chip Starting Distance (yds)</h2>
    <div id="distanceGrid">
      <button>10</button><button>15</button><button>20</button><button>25</button><button>30</button><button>35</button>
      <button>40</button><button>45</button><button>50</button><button>55</button><button>60</button><button>65</button>
    </div>
  </section>

  <section class="panel">
    <h2 class="h2-center-white">Lie</h2>
    <div class="chips" id="lieChips">
      <div class="pill" data-lie="Fairway">Fairway</div>
      <div class="pill" data-lie="Rough">Rough</div>
      <div class="pill" data-lie="Sand">Sand</div>
      <div class="pill" data-lie="Recovery">Recovery</div>
    </div>
  </section>

  <!-- Chip result (hidden until Lie chosen) -->
  <section class="panel hidden" id="chipSection">
    <h2 class="h2-center-white helpwrap" id="chipHelpWrap">
      <span class="helpbtn" id="chipHelpBtn">Input Chip Result <span class="subNote">(distance from hole)</span></span>
      <span class="tip" id="chipHelpTip">Enter how short/long and which side (L/R) the ball finished from the hole.</span>
    </h2>
    <div class="row divider-2cols">
      <div class="field">
        <div class="microlabel ml-left">Short</div>
        <div class="microlabel ml-right">Long</div>
        <div class="stepper">
          <button class="step" id="depthDown">â–¼</button>
          <div class="readout">
            <input id="depthInput" class="readnum" type="text" inputmode="text" pattern="-?\\d{1,2}" maxlength="3" value="0" aria-label="Depth signed feet" />
            <span class="unit">ft</span>
          </div>
          <button class="step" id="depthUp">â–²</button>
        </div>
        <div id="depthModeTag" class="modeTag">Exact</div>
        <div class="capHint" id="capHintDepthChip">Capped at Â±99</div>
      </div>
      <div class="vdiv" aria-hidden="true"></div>
      <div class="field">
        <div class="microlabel ml-left">Left</div>
        <div class="microlabel ml-right">Right</div>
        <div class="stepper">
          <button class="step" id="lineLeft">â—€</button>
          <div class="readout">
            <input id="lineInput" class="readnum" type="text" inputmode="text" pattern="-?\\d{1,2}" maxlength="3" value="0" aria-label="Line signed feet" />
            <span class="unit">ft</span>
          </div>
          <button class="step" id="lineRight">â–¶</button>
        </div>
        <div id="lineModeTag" class="modeTag">Straight</div>
        <div class="capHint" id="capHintLineChip">Capped at Â±99</div>
      </div>
    </div>
  </section>

  <!-- Putt 1 -->
  <section class="panel hidden" id="sectionP1">
    <!-- header with derived leave bubble -->
    <h2 class="h2-center-white helpwrap" id="putt1HeaderWrap">
      <span class="helpbtn" id="putt1HeaderBtn">Putt 1</span>
      <span class="tip" id="putt1HeaderTip">Derived leave from chip: â€”</span>
    </h2>

    <div class="inlinePuttRow" aria-label="First putt distance">
      <div class="input slim p1"><input id="putt1Dist" type="number" min="0" step="1" placeholder="0" inputmode="numeric" /></div>
      <span class="unit">ft</span>
    </div>

    <h2 class="h2-center-white helpwrap" id="puttHelpWrap">
      <span class="helpbtn" id="puttHelpBtn">Input Putt 1 Result <span class="subNote">(distance from hole)</span></span>
      <span class="tip" id="puttHelpTip">Enter how short/long and which side (L/R) the ball finished after the first putt.</span>
    </h2>

    <div class="row divider-2cols" style="margin-top:8px;">
      <div class="field">
        <div class="microlabel ml-left">Short</div>
        <div class="microlabel ml-right">Long</div>
        <div class="stepper">
          <button class="step" id="depthDownP1">â–¼</button>
          <div class="readout">
            <input id="depthInputP1" class="readnum" type="text" inputmode="text" pattern="-?\\d{1,2}" maxlength="3" value="0" aria-label="Putt 1 depth signed feet" />
            <span class="unit">ft</span>
          </div>
          <button class="step" id="depthUpP1">â–²</button>
        </div>
        <div id="depthModeTagP1" class="modeTag">Exact</div>
        <div class="capHint" id="capHintDepthP1">Capped at Â±99</div>
      </div>
      <div class="vdiv" aria-hidden="true"></div>
      <div class="field">
        <div class="microlabel ml-left">Left</div>
        <div class="microlabel ml-right">Right</div>
        <div class="stepper">
          <button class="step" id="lineLeftP1">â—€</button>
          <div class="readout">
            <input id="lineInputP1" class="readnum" type="text" inputmode="text" pattern="-?\\d{1,2}" maxlength="3" value="0" aria-label="Putt 1 line signed feet" />
            <span class="unit">ft</span>
          </div>
          <button class="step" id="lineRightP1">â–¶</button>
        </div>
        <div id="lineModeTagP1" class="modeTag">Straight</div>
        <div class="capHint" id="capHintLineP1">Capped at Â±99</div>
      </div>
    </div>
  </section>

  <!-- Putts 2 & 3 -->
  <section class="panel hidden" id="sectionP23">
    <h2 class="h2-center-white helpwrap" id="p23HeaderWrap">
      <span class="helpbtn" id="p23HeaderBtn">Putts 2 & 3 (distances only)</span>
      <span class="tip" id="p23HeaderTip">Derived leave after Putt 1: â€”</span>
    </h2>
    <div class="row" style="margin-top:8px;">
      <div class="field">
        <div class="subtle">Putt 2 (ft)</div>
        <div class="input"><input id="putt2" type="number" min="0" step="1" placeholder="0" inputmode="numeric" /></div>
      </div>
      <div class="field">
        <div class="subtle">Putt 3 (ft)</div>
        <div class="input"><input id="putt3" type="number" min="0" step="1" placeholder="0" inputmode="numeric" /></div>
      </div>
    </div>
  </section>

  <!-- Save / Reset -->
  <section class="panel footer">
    <button class="btn save" id="saveBtn">Save Hole: â€”</button>
    <div class="scoreline"><strong>Score:</strong> <span id="score">â€”</span></div>
    <div></div>
    <button class="btn undo" id="undoBtn">Reset Hole</button>
  </section>

  <!-- Log -->
  <section class="panel">
    <table class="tight">
      <thead>
        <tr>
          <th>#</th><th>Date</th><th>Lie</th><th>Dist</th>
          <th>Putt 1</th><th>Putt 2</th><th>Putt 3</th><th>Score</th>
        </tr>
      </thead>
      <tbody id="logBody"></tbody>
    </table>
  </section>

  <!-- Chart toggle -->
  <section class="panel">
    <button class="btn full chartToggle" id="toggleChartBtn">Show Dispersion Chart</button>
  </section>

  <!-- Chart + filters -->
  <section class="panel hidden" id="chartPanel">
    <h2 style="display:flex;justify-content:space-between;align-items:center; gap:8px; color:#fff; font-size:16px;">
      <span>Session Dispersion (ft)</span>
      <span class="seg" id="colorModeSeg">
        <button data-mode="lie" class="active">Lie</button>
        <button data-mode="distance">Distance</button>
      </span>
    </h2>
    <canvas id="chipChart" width="380" height="280"></canvas>
    <div class="filterbar subtle" id="dynFilterRow"></div>
    <div style="display:flex;justify-content:space-between;margin-top:8px;flex-wrap:wrap;gap:8px;">
      <button class="rowbtn" id="exportChartBtn">Export Chart PNG</button>
      <button class="rowbtn" id="exportPanelJpgBtn">Export Panel JPG</button>
      <button class="rowbtn" id="resetFiltersBtn">Reset filters</button>
    </div>
  </section>
</main>

<!-- Toast -->
<div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
  const r0 = (n) => Math.round(Number(n) || 0);
  const clamp = (n, min, max) => Math.max(min, Math.min(max, n));

  let selectedDist = null, selectedLie = "", saved = [];
  let colorMode = "lie";
  const activeCats = { Fairway:true, Rough:true, Sand:true, Recovery:true, d1:true, d2:true, d3:true };
  const includeChipInsInUpDown = true;

  const holeInput = document.getElementById("hole");
  const dateInput = document.getElementById("date");
  const saveBtn   = document.getElementById("saveBtn");
  const toastEl   = document.getElementById("toast");

  function showToast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    setTimeout(()=> toastEl.classList.remove('show'), 1300);
  }

  function updateSaveLabel(){
    const n = parseInt(holeInput.value||"",10);
    saveBtn.textContent = `Save Hole: ${Number.isFinite(n) && n>0 ? n : "â€”"}`;
  }

  document.getElementById("holeMinus").onclick = () => { holeInput.value = Math.max(1, parseInt(holeInput.value||"1")-1); onHoleChange(); };
  document.getElementById("holePlus").onclick  = () => { holeInput.value = parseInt(holeInput.value||"1")+1; onHoleChange(); };
  holeInput.addEventListener('change', onHoleChange);
  dateInput.value = new Date().toISOString().slice(0,10);
  updateSaveLabel();

  // Smooth scroll helper
  function smoothFocus(el){
    if (!el) return;
    requestAnimationFrame(()=> setTimeout(()=> el.scrollIntoView({ behavior:'smooth', block:'center' }), 30));
  }

  // Distance (toggle on/off; scroll to chip if lie already chosen)
  const distButtons = Array.from(document.querySelectorAll("#distanceGrid button"));
  distButtons.forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const val = parseInt(btn.textContent,10);
      if (btn.classList.contains('active')) {
        btn.classList.remove('active');
        selectedDist = null;
      } else {
        distButtons.forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        selectedDist = val;
        // If a lie is already chosen and chip section visible, focus it
        if (selectedLie && !document.getElementById('chipSection').classList.contains('hidden')){
          smoothFocus(document.getElementById('chipSection'));
        }
      }
      calcAll();
    });
  });

  // Lie (toggle on/off) + always scroll to Chip when showing
  const lieButtons = document.querySelectorAll("#lieChips .pill");
  function updateChipVisibility(scrollOnShow=false){
    const sec = document.getElementById("chipSection");
    const shouldShow = !!selectedLie;
    sec.classList.toggle("hidden", !shouldShow);
    if (shouldShow && scrollOnShow) smoothFocus(sec);
  }
  lieButtons.forEach(p=>{
    p.addEventListener("click", ()=>{
      const already = p.classList.contains('active');
      lieButtons.forEach(x=>x.classList.remove("active"));
      if (already) {
        selectedLie = "";
        updateChipVisibility(false);
      } else {
        p.classList.add("active");
        selectedLie = p.dataset.lie;
        updateChipVisibility(true);
      }
      calcAll();
    });
  });

  // ----- Signed steppers â€” CHIP
  let depthSigned = 0, lineSigned  = 0;
  const depthInputEl = document.getElementById('depthInput');
  const lineInputEl  = document.getElementById('lineInput');
  const depthTag   = document.getElementById('depthModeTag');
  const lineTag    = document.getElementById('lineModeTag');
  const capDepthChip = document.getElementById('capHintDepthChip');
  const capLineChip  = document.getElementById('capHintLineChip');

  let pendingDepth=false, pendingLine=false;
  function showCap(el){ el.classList.add('show'); setTimeout(()=> el.classList.remove('show'), 1200); }
  function normalizeSignedText(el){
    let raw = (el.value||"");
    let v = raw.replace(/[â€“âˆ’]/g,'-').replace(/[^0-9-]/g,'');
    if (v === '' || v === '-') return {pending:true, num:0, text:v, capped:false};
    let n = parseInt(v,10); if (isNaN(n)) n = 0;
    const capped = n > 99 || n < -99;
    n = clamp(n, -99, 99);
    return {pending:false, num:n, text:String(n), capped};
  }
  function updateChipStepperUI(){
    if (!pendingDepth) depthInputEl.value = String(depthSigned);
    if (!pendingLine)  lineInputEl.value  = String(lineSigned);
    depthTag.textContent = depthSigned<0? 'Short' : depthSigned>0? 'Long' : 'Exact';
    lineTag.textContent  = lineSigned<0 ? 'Left'  : lineSigned>0 ? 'Right': 'Straight';
  }

  function addAutoRepeat(btn, stepFn){
    let holdT=null, repI=null, active=false;
    const start=(e)=>{ e.preventDefault(); if(active) return; active=true; stepFn();
      holdT=setTimeout(()=>{ repI=setInterval(()=>{ stepFn(); }, 80); }, 400);
    };
    const stop=()=>{ active=false; clearTimeout(holdT); clearInterval(repI); holdT=null; repI=null; };
    btn.addEventListener('mousedown', start);
    btn.addEventListener('touchstart', start, {passive:false});
    ['mouseup','mouseleave','touchend','touchcancel'].forEach(ev=> btn.addEventListener(ev, stop));
  }

  const depthDown = document.getElementById('depthDown');
  const depthUp   = document.getElementById('depthUp');
  const lineLeft  = document.getElementById('lineLeft');
  const lineRight = document.getElementById('lineRight');

  depthDown.onclick = ()=>{ pendingDepth=false; const prev=depthSigned; depthSigned = clamp(depthSigned - 1, -99, 99); if(prev===-99) showCap(capDepthChip); updateChipStepperUI(); calcAll(); };
  depthUp.onclick   = ()=>{ pendingDepth=false; const prev=depthSigned; depthSigned = clamp(depthSigned + 1, -99, 99); if(prev===99)  showCap(capDepthChip); updateChipStepperUI(); calcAll(); };
  lineLeft.onclick  = ()=>{ pendingLine=false;  const prev=lineSigned;  lineSigned  = clamp(lineSigned  - 1, -99, 99); if(prev===-99) showCap(capLineChip);  updateChipStepperUI(); calcAll(); };
  lineRight.onclick = ()=>{ pendingLine=false;  const prev=lineSigned;  lineSigned  = clamp(lineSigned  + 1, -99, 99); if(prev===99)  showCap(capLineChip);  updateChipStepperUI(); calcAll(); };

  addAutoRepeat(depthDown, ()=>{ const prev=depthSigned; depthSigned=clamp(depthSigned-1,-99,99); if(prev===-99) showCap(capDepthChip); updateChipStepperUI(); calcAll(); });
  addAutoRepeat(depthUp,   ()=>{ const prev=depthSigned; depthSigned=clamp(depthSigned+1,-99,99); if(prev===99)  showCap(capDepthChip); updateChipStepperUI(); calcAll(); });
  addAutoRepeat(lineLeft,  ()=>{ const prev=lineSigned;  lineSigned =clamp(lineSigned -1,-99,99); if(prev===-99) showCap(capLineChip);  updateChipStepperUI(); calcAll(); });
  addAutoRepeat(lineRight, ()=>{ const prev=lineSigned;  lineSigned =clamp(lineSigned +1,-99,99); if(prev===99)  showCap(capLineChip);  updateChipStepperUI(); calcAll(); });

  depthInputEl.addEventListener('focus', ()=> depthInputEl.select());
  lineInputEl .addEventListener('focus', ()=> lineInputEl.select());
  depthInputEl.addEventListener('input', ()=>{
    const r = normalizeSignedText(depthInputEl);
    pendingDepth=r.pending; depthSigned=r.num; if(!r.pending) depthInputEl.value=r.text; if(r.capped) showCap(capDepthChip);
    updateChipStepperUI(); calcAll();
  });
  lineInputEl .addEventListener('input', ()=>{
    const r = normalizeSignedText(lineInputEl );
    pendingLine=r.pending;  lineSigned=r.num; if(!r.pending) lineInputEl.value=r.text;  if(r.capped) showCap(capLineChip);
    updateChipStepperUI(); calcAll();
  });

  // ----- Signed steppers â€” PUTT 1
  let depthSignedP1 = 0, lineSignedP1 = 0;
  const depthInputP1 = document.getElementById('depthInputP1');
  const lineInputP1  = document.getElementById('lineInputP1');
  const depthTagP1   = document.getElementById('depthModeTagP1');
  const lineTagP1    = document.getElementById('lineModeTagP1');
  const capDepthP1   = document.getElementById('capHintDepthP1');
  const capLineP1    = document.getElementById('capHintLineP1');

  let pendingDepthP1=false, pendingLineP1=false;
  function updateP1StepperUI(){
    if (!pendingDepthP1) depthInputP1.value = String(depthSignedP1);
    if (!pendingLineP1)  lineInputP1.value  = String(lineSignedP1);
    depthTagP1.textContent = depthSignedP1<0? 'Short' : depthSignedP1>0? 'Long' : 'Exact';
    lineTagP1.textContent  = lineSignedP1<0 ? 'Left'  : lineSignedP1>0 ? 'Right': 'Straight';
  }

  const depthDownP1 = document.getElementById('depthDownP1');
  const depthUpP1   = document.getElementById('depthUpP1');
  const lineLeftP1  = document.getElementById('lineLeftP1');
  const lineRightP1 = document.getElementById('lineRightP1');

  depthDownP1.onclick = ()=>{ pendingDepthP1=false; const prev=depthSignedP1; depthSignedP1 = clamp(depthSignedP1 - 1, -99, 99); if(prev===-99) capDepthP1.classList.add('show'); updateP1StepperUI(); calcAll(); setTimeout(()=>capDepthP1.classList.remove('show'),1200); };
  depthUpP1.onclick   = ()=>{ pendingDepthP1=false; const prev=depthSignedP1; depthSignedP1 = clamp(depthSignedP1 + 1, -99, 99); if(prev===99)  capDepthP1.classList.add('show'); updateP1StepperUI(); calcAll(); setTimeout(()=>capDepthP1.classList.remove('show'),1200); };
  lineLeftP1.onclick  = ()=>{ pendingLineP1=false;  const prev=lineSignedP1;  lineSignedP1  = clamp(lineSignedP1  - 1, -99, 99); if(prev===-99) capLineP1.classList.add('show');  updateP1StepperUI(); calcAll(); setTimeout(()=>capLineP1.classList.remove('show'),1200); };
  lineRightP1.onclick = ()=>{ pendingLineP1=false;  const prev=lineSignedP1;  lineSignedP1  = clamp(lineSignedP1  + 1, -99, 99); if(prev===99)  capLineP1.classList.add('show');  updateP1StepperUI(); calcAll(); setTimeout(()=>capLineP1.classList.remove('show'),1200); };

  addAutoRepeat(depthDownP1, ()=>{ const prev=depthSignedP1; depthSignedP1=clamp(depthSignedP1-1,-99,99); if(prev===-99) capDepthP1.classList.add('show'); updateP1StepperUI(); calcAll(); setTimeout(()=>capDepthP1.classList.remove('show'),1200); });
  addAutoRepeat(depthUpP1,   ()=>{ const prev=depthSignedP1; depthSignedP1=clamp(depthSignedP1+1,-99,99); if(prev===99)  capDepthP1.classList.add('show'); updateP1StepperUI(); calcAll(); setTimeout(()=>capDepthP1.classList.remove('show'),1200); });
  addAutoRepeat(lineLeftP1,  ()=>{ const prev=lineSignedP1;  lineSignedP1 =clamp(lineSignedP1 -1,-99,99); if(prev===-99) capLineP1.classList.add('show');  updateP1StepperUI(); calcAll(); setTimeout(()=>capLineP1.classList.remove('show'),1200); });
  addAutoRepeat(lineRightP1, ()=>{ const prev=lineSignedP1;  lineSignedP1 =clamp(lineSignedP1 +1,-99,99); if(prev===99)  capLineP1.classList.add('show');  updateP1StepperUI(); calcAll(); setTimeout(()=>capLineP1.classList.remove('show'),1200); });

  depthInputP1.addEventListener('focus', ()=> depthInputP1.select());
  lineInputP1 .addEventListener('focus', ()=> lineInputP1.select());
  depthInputP1.addEventListener('input', ()=>{
    const r = normalizeSignedText(depthInputP1);
    pendingDepthP1=r.pending; depthSignedP1=r.num; if(!r.pending) depthInputP1.value=r.text; if(r.capped) capDepthP1.classList.add('show'), setTimeout(()=>capDepthP1.classList.remove('show'),1200);
    updateP1StepperUI(); calcAll();
  });
  lineInputP1 .addEventListener('input', ()=>{
    const r = normalizeSignedText(lineInputP1 );
    pendingLineP1=r.pending;  lineSignedP1=r.num; if(!r.pending) lineInputP1.value=r.text;  if(r.capped) capLineP1.classList.add('show'), setTimeout(()=>capLineP1.classList.remove('show'),1200);
    updateP1StepperUI(); calcAll();
  });

  // Other fields
  const putt1Dist   = document.getElementById("putt1Dist");
  const p2          = document.getElementById("putt2");
  const p3          = document.getElementById("putt3");
  const scoreEl     = document.getElementById("score");

  ["putt1Dist","putt2","putt3"].forEach(id=>{
    const el = document.getElementById(id);
    el.addEventListener("change", () => { el.value = el.value === "" ? "" : r0(el.value); calcAll(); });
    el.addEventListener("input", calcAll);
  });

  function leaveFromSigned(dSigned, lSigned){
    const D = Math.abs(r0(dSigned)), L = Math.abs(r0(lSigned));
    const leave = Math.sqrt(D*D + L*L);
    return { leave:r0(leave), dSigned:r0(dSigned), lSigned:r0(lSigned),
      depthDir: dSigned<0? 'Short' : dSigned>0? 'Long' : 'Exact',
      lineDir:  lSigned<0? 'Left'  : lSigned>0 ? 'Right': 'Straight' };
  }

  function updateVisibility(chipHasInput, p1HasInput){
    document.getElementById("sectionP1").classList.toggle("hidden", !chipHasInput);
    document.getElementById("sectionP23").classList.toggle("hidden", !p1HasInput);
  }

  // Helper tip wiring (click + scroll dismiss)
  const chipHelpWrap = document.getElementById('chipHelpWrap');
  const chipHelpBtn  = document.getElementById('chipHelpBtn');
  const puttHelpWrap = document.getElementById('puttHelpWrap');
  const puttHelpBtn  = document.getElementById('puttHelpBtn');
  const putt1HeaderWrap = document.getElementById('putt1HeaderWrap');
  const putt1HeaderBtn  = document.getElementById('putt1HeaderBtn');
  const p23HeaderWrap   = document.getElementById('p23HeaderWrap');
  const p23HeaderBtn    = document.getElementById('p23HeaderBtn');

  function closeAllTips(){ [chipHelpWrap, puttHelpWrap, putt1HeaderWrap, p23HeaderWrap].forEach(w=> w && w.classList.remove('open')); }
  function toggleTip(wrap){ const wasOpen = wrap.classList.contains('open'); closeAllTips(); if (!wasOpen) wrap.classList.add('open'); }

  chipHelpBtn.addEventListener('click', (e)=>{ e.stopPropagation(); toggleTip(chipHelpWrap); });
  puttHelpBtn.addEventListener('click', (e)=>{ e.stopPropagation(); toggleTip(puttHelpWrap); });
  putt1HeaderBtn.addEventListener('click', (e)=>{ e.stopPropagation(); toggleTip(putt1HeaderWrap); });
  p23HeaderBtn.addEventListener('click', (e)=>{ e.stopPropagation(); toggleTip(p23HeaderWrap); });
  document.addEventListener('click', closeAllTips);
  window.addEventListener('scroll', closeAllTips, {passive:true});

  // Update derived-leave helper texts
  function updateDerivedBubbles(chip, p1){
    const p1Tip = document.getElementById('putt1HeaderTip');
    if (p1Tip){
      if (Math.abs(depthSigned) || Math.abs(lineSigned)){
        p1Tip.textContent = `Derived leave from chip: ${chip.leave} ft (${chip.depthDir} ${Math.abs(chip.dSigned)} / ${chip.lineDir} ${Math.abs(chip.lSigned)})`;
      } else {
        p1Tip.textContent = 'Derived leave from chip: â€”';
      }
    }
    const p23Tip = document.getElementById('p23HeaderTip');
    if (p23Tip){
      if (Math.abs(depthSignedP1) || Math.abs(lineSignedP1)){
        p23Tip.textContent = `Derived leave after Putt 1: ${p1.leave} ft (${p1.depthDir} ${Math.abs(p1.dSigned)} / ${p1.lineDir} ${Math.abs(p1.lSigned)})`;
      } else {
        p23Tip.textContent = 'Derived leave after Putt 1: â€”';
      }
    }
  }

  function calcAll(){
    const chip = leaveFromSigned(depthSigned, lineSigned);
    const p1   = leaveFromSigned(depthSignedP1, lineSignedP1);

    // write derived info into helper bubbles
    updateDerivedBubbles(chip, p1);

    // auto-fill next distances
    const chipHasInput = (Math.abs(depthSigned) || Math.abs(lineSigned)) > 0;
    const p1HasInput   = (Math.abs(depthSignedP1) || Math.abs(lineSignedP1)) > 0;

    document.getElementById("putt1Dist").value = chipHasInput && chip.leave>0 ? chip.leave : "";
    document.getElementById("putt2").value     = p1HasInput   && p1.leave>0   ? p1.leave   : "";

    updateVisibility(chipHasInput, p1HasInput);

    let strokes = 1, putts = 0;
    if (r0(putt1Dist.value) > 0) putts++;
    if (r0(p2.value) > 0) putts++;
    if (r0(p3.value) > 0) putts++;
    strokes += putts;
    if (chip.leave===0 && putts===0) strokes = 1;
    scoreEl.textContent = (!selectedDist || !selectedLie) ? "â€”" : strokes;
  }

  function clearUISelections(){
    distButtons.forEach(b=>b.classList.remove("active")); selectedDist=null;
    lieButtons.forEach(x=>x.classList.remove("active")); selectedLie = "";
    depthSigned=0; lineSigned=0; pendingDepth=false; pendingLine=false; updateChipStepperUI();
    depthSignedP1=0; lineSignedP1=0; pendingDepthP1=false; pendingLineP1=false; updateP1StepperUI();
    putt1Dist.value=""; p2.value=""; p3.value="";
    document.getElementById("chipSection").classList.add("hidden");
    document.getElementById("sectionP1").classList.add("hidden");
    document.getElementById("sectionP23").classList.add("hidden");
    scoreEl.textContent = "â€”";
  }

  function applyRowToUI(r){
    clearUISelections();
    selectedDist = Number(r.dist)||null;
    if (selectedDist){ const btn = distButtons.find(b=> Number(b.textContent) === selectedDist); if (btn){ btn.classList.add('active'); } }
    selectedLie = r.lie || "";
    if (selectedLie){ document.querySelectorAll('#lieChips .pill').forEach(b=> b.classList.toggle('active', b.dataset.lie===selectedLie)); }
    updateChipVisibility();

    depthSigned = Number(r.chipDepthSigned||0);
    lineSigned  = Number(r.chipLateralSigned||0);
    updateChipStepperUI();

    depthSignedP1 = Number(r.p1DepthSigned||0);
    lineSignedP1  = Number(r.p1LateralSigned||0);
    updateP1StepperUI();

    putt1Dist.value = r.p1 || '';
    p2.value = r.p2 || '';
    p3.value = r.p3 || '';

    const chipHasInput = (Math.abs(depthSigned) || Math.abs(lineSigned)) > 0;
    const p1HasInput   = (Math.abs(depthSignedP1) || Math.abs(lineSignedP1)) > 0;
    updateVisibility(chipHasInput, p1HasInput);
    calcAll();
  }
  function findSavedByHole(h){ const list = saved.filter(x => Number(x.hole) === Number(h)); return list.length ? list[list.length-1] : null; }
  function onHoleChange(){ const h = parseInt(holeInput.value || '1', 10); const rec = findSavedByHole(h); if (rec) applyRowToUI(rec); else clearUISelections(); updateSaveLabel(); }

  function renderLog(){
    const tbody = document.getElementById("logBody");
    tbody.innerHTML = "";
    saved.forEach((r,idx)=>{
      const tr = document.createElement("tr");
      tr.dataset.idx = idx;
      tr.innerHTML = `
        <td>${r.hole}</td><td>${r.date}</td><td>${r.lie}</td><td>${r.dist} yd</td>
        <td>${r.p1 || ""}${r.p1? " ft": ""}</td>
        <td>${r.p2 || ""}${r.p2? " ft": ""}</td>
        <td>${r.p3 || ""}${r.p3? " ft": ""}</td>
        <td class="score-cell">${r.score}<button class="rowbtn" data-del="${idx}" title="Delete">ðŸ—‘</button></td>`;
      tbody.appendChild(tr);
    });

    // delete only
    tbody.querySelectorAll('button[data-del]').forEach(btn=>{
      btn.onclick = ()=>{
        const i = Number(btn.getAttribute('data-del'));
        saved.splice(i,1);
        renderLog();
      };
    });

    const holes = saved.length, par = holes*2, total = saved.reduce((s,r)=>s+(Number(r.score)||0),0);
    const attempts = holes;
    const successes = saved.filter(r => (includeChipInsInUpDown ? r.score <= 2 : r.score === 2)).length;
    const updownPct = attempts ? Math.round((successes/attempts)*100) : 0;
    const over = total - par; const overLabel = over > 0 ? `+${over}` : `${over}`;
    const sumTxt = `Par: ${par} | Gross: ${total} | Up/Down: ${updownPct}% | To Par: ${overLabel}`;
    const sbTop = document.getElementById("summaryBarTop"); if (sbTop) sbTop.textContent = sumTxt;

    renderFilterRow(); renderChart();
  }

  function downloadBlob(filename, blob){
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = filename;
    const supportsDownload = typeof a.download !== 'undefined'; const isiOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    if (!supportsDownload || isiOS){ window.open(url, '_blank'); }
    else { document.body.appendChild(a); a.click(); document.body.removeChild(a); }
    setTimeout(()=>URL.revokeObjectURL(url), 1500);
  }

  document.getElementById("saveBtn").addEventListener("click", () => {
    if (!selectedDist || !selectedLie){ alert('Please select a Chip Starting Distance and a Lie before saving.'); return; }
    const hole = parseInt(holeInput.value||"1",10);
    const date = dateInput.value || new Date().toISOString().slice(0,10);

    const chip = leaveFromSigned(depthSigned, lineSigned);
    const p1   = leaveFromSigned(depthSignedP1, lineSignedP1);

    let strokes = 1, putts = 0;
    const p1d = r0(putt1Dist.value); if (p1d>0) putts++;
    const p2d = r0(p2.value);       if (p2d>0) putts++;
    const p3d = r0(p3.value);       if (p3d>0) putts++;
    strokes += putts;
    if (chip.leave===0 && putts===0) strokes = 1;

    const row = {
      hole, date, lie: selectedLie || "", dist: selectedDist ?? "",
      chipLeave: chip.leave, chipDepthSigned: chip.dSigned, chipLateralSigned: chip.lSigned,
      chipDepthDir: chip.depthDir, chipLineDir: chip.lineDir,
      chipX: chip.lSigned, chipY: chip.dSigned,
      p1: p1d || "", p1DepthSigned: p1.dSigned || "", p1LateralSigned: p1.lSigned || "",
      p1DepthDir: p1.depthDir || "", p1LineDir: p1.lineDir || "",
      p2: p2d || "", p3: p3d || "", score: strokes
    };

    const idx = saved.findIndex(x => Number(x.hole) === hole);
    if (idx >= 0) saved[idx] = row; else saved.push(row);

    renderLog();
    showToast(`Saved hole ${hole}`);
    holeInput.value = hole + 1;
    updateSaveLabel();
    clearUISelections();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  document.getElementById("undoBtn").addEventListener("click", () => {
    clearUISelections();
    window.scrollTo({ top: 0, behavior: 'smooth' });   // scroll to top after reset hole
  });

  document.getElementById("exportBtn").addEventListener("click", () => {
    const cols = [
      "hole","date","lie","dist_yd",
      "chip_leave_ft","chip_depth_ft_signed","chip_lateral_ft_signed","chip_depth_dir","chip_line_dir",
      "putt1_ft","putt1_depth_ft_signed","putt1_lateral_ft_signed","putt1_depth_dir","putt1_line_dir",
      "putt2_ft","putt3_ft","score"
    ];
    const rows = [cols];
    saved.forEach(r=>{
      rows.push([
        r.hole, r.date, r.lie, r.dist,
        r.chipLeave, r.chipDepthSigned, r.chipLateralSigned, r.chipDepthDir, r.chipLineDir,
        r.p1 || "", r.p1DepthSigned || "", r.p1LateralSigned || "", r.p1DepthDir || "", r.p1LineDir || "",
        r.p2 || "", r.p3 || "", r.score
      ]);
    });
    const csv = rows.map(a=>a.join(",")).join("\n");
    const blob = new Blob(["\ufeff"+csv],{type:"text/csv;charset=utf-8;"});
    downloadBlob('par2_export.csv', blob);
  });

  // Chart export PNG (image-only)
  document.getElementById('exportChartBtn').addEventListener('click', ()=>{
    const cv = document.getElementById('chipChart');
    if (!cv) return;
    const dataUrl = cv.toDataURL('image/png');
    const win = window.open('', '_blank');
    if (win) {
      win.document.write('<!doctype html><html><head><title>Dispersion Chart</title><meta name="viewport" content="width=device-width, initial-scale=1"/></head><body style="margin:0;background:#000;display:flex;align-items:center;justify-content:center;height:100vh;"><img alt="Dispersion Chart" style="max-width:100vw;max-height:100vh" src="'+dataUrl+'"/></body></html>');
      win.document.close();
    } else {
      location.href = dataUrl;
    }
  });

  // Chart export JPG (whole panel: header + bg + filters + chart)
  document.getElementById('exportPanelJpgBtn').addEventListener('click', ()=>{
    const panel = document.getElementById('chartPanel');
    const chart = document.getElementById('chipChart');
    if (!panel || !chart) return;

    const dpr = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
    const pad = 16, lineH = 18, pillGap = 8, pillPadX = 10, pillPadY = 6, radius = 10;

    const W = panel.clientWidth;
    const chartH = chart.height;
    const headerH = 26 + 8; // title + spacing
    const filters = Array.from(document.getElementById('dynFilterRow').children);
    // estimate filter height
    let filterRows = 1, rowW = 0;
    filters.forEach(el=>{
      const text = el.textContent.trim();
      const est = (text.length * 7) + pillPadX*2 + 2 /*border*/ + pillGap;
      if (rowW + est > W - pad*2){ filterRows++; rowW = est; } else { rowW += est; }
    });
    const filterH = filterRows * (lineH + pillPadY*2 + pillGap) + 6;

    const H = headerH + chartH + filterH + pad*2;

    const canvas = document.createElement('canvas');
    canvas.width  = Math.floor(W * dpr);
    canvas.height = Math.floor(H * dpr);
    const ctx = canvas.getContext('2d');
    ctx.scale(dpr, dpr);

    // background (panel)
    const panelBg = getComputedStyle(panel).backgroundColor || '#1a1f24';
    ctx.fillStyle = panelBg;
    ctx.fillRect(0, 0, W, H);

    // header text
    ctx.fillStyle = '#ffffff';
    ctx.font = '16px system-ui, -apple-system, Segoe UI, Roboto, Arial';
    ctx.textBaseline = 'top';
    ctx.fillText('Session Dispersion (ft)  â€”  Color by ' + (colorMode==='lie' ? 'Lie' : 'Distance'), pad, pad);

    // chart image
    const chartURL = chart.toDataURL('image/png');
    const img = new Image();
    img.onload = ()=>{
      ctx.drawImage(img, (W - chart.width)/2, pad + headerH, chart.width, chart.height);

      // filters
      let x = pad, y = pad + headerH + chartH + 8;
      ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      filters.forEach(el=>{
        const label = el.textContent.trim();
        const active = !el.classList.contains('off');
        // color from class
        const cls = Array.from(el.classList).find(c=>/^flt-/.test(c)) || '';
        const colorMap = {
          'flt-fairway':'#7CFC00','flt-rough':'#ffa74d','flt-sand':'#e8d27c','flt-recovery':'#ff5a5a',
          'flt-d1':'#9cdcfe','flt-d2':'#a6e22e','flt-d3':'#ffb454'
        };
        const stroke = colorMap[cls] || '#9aa7b2';
        const textW = ctx.measureText(label).width;
        const pillW = Math.ceil(textW + pillPadX*2);
        const pillH = lineH + pillPadY*2;

        if (x + pillW > W - pad) { x = pad; y += pillH + pillGap; }

        // rounded rect
        ctx.save();
        roundRect(ctx, x, y, pillW, pillH, radius);
        ctx.strokeStyle = stroke;
        ctx.globalAlpha = active ? 1 : 0.45;
        ctx.stroke();
        ctx.globalAlpha = 1;
        ctx.restore();

        // text
        ctx.fillStyle = stroke;
        ctx.fillText(label, x + pillPadX, y + pillPadY);
        x += pillW + pillGap;
      });

      const jpg = canvas.toDataURL('image/jpeg', 0.92);
      const win = window.open('', '_blank');
      if (win) {
        win.document.write('<!doctype html><html><head><title>Dispersion Panel</title><meta name="viewport" content="width=device-width, initial-scale=1"/></head><body style="margin:0;background:#000;display:flex;align-items:center;justify-content:center;height:100vh;"><img alt="Dispersion Panel" style="max-width:100vw;max-height:100vh" src="'+jpg+'"/></body></html>');
        win.document.close();
      } else {
        location.href = jpg;
      }
    };
    img.src = chartURL;

    function roundRect(ctx,x,y,w,h,r){
      const rr = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x+rr, y);
      ctx.arcTo(x+w, y, x+w, y+h, rr);
      ctx.arcTo(x+w, y+h, x, y+h, rr);
      ctx.arcTo(x, y+h, x, y, rr);
      ctx.arcTo(x, y, x+w, y, rr);
      ctx.closePath();
    }
  });

  document.getElementById("clearBtn").addEventListener("click", () => {
    if (!confirm('Clear EVERYTHING? This removes all saved holes and resets the form.')) return;
    saved = []; holeInput.value = 1; dateInput.value = new Date().toISOString().slice(0,10);
    clearUISelections(); renderLog();
    document.getElementById('summaryBarTop').textContent = 'Par: 0 | Gross: 0 | Up/Down: 0% | To Par: 0';
    updateSaveLabel();
    document.getElementById('chartPanel').classList.add('hidden');
    document.getElementById('toggleChartBtn').textContent = 'Show Dispersion Chart';
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  // Color toggle & filters
  document.querySelectorAll('#colorModeSeg button').forEach(b=>{
    b.addEventListener('click', ()=>{
      document.querySelectorAll('#colorModeSeg button').forEach(x=>x.classList.remove('active'));
      b.classList.add('active'); colorMode = b.dataset.mode;
      renderFilterRow(); renderChart();
    });
  });
  document.getElementById('resetFiltersBtn').addEventListener('click', ()=>{
    Object.keys(activeCats).forEach(k=> activeCats[k] = true); renderFilterRow(); renderChart();
  });

  const chartPanel = document.getElementById('chartPanel');
  const toggleChartBtn = document.getElementById('toggleChartBtn');
  toggleChartBtn.addEventListener('click', ()=>{
    const willShow = chartPanel.classList.contains('hidden');
    if (willShow){
      chartPanel.classList.remove('hidden');
      toggleChartBtn.textContent = 'Hide Dispersion Chart';
      renderChart();
      setTimeout(()=> chartPanel.scrollIntoView({behavior:'smooth', block:'start'}), 50);
    } else {
      chartPanel.classList.add('hidden');
      toggleChartBtn.textContent = 'Show Dispersion Chart';
    }
  });

  function renderFilterRow(){
    const row = document.getElementById('dynFilterRow');
    row.innerHTML = "";
    if (colorMode === "lie"){
      ["Fairway","Rough","Sand","Recovery"].forEach(k=>{
        const span = document.createElement('span');
        span.className = `flt flt-${k.toLowerCase()} ${activeCats[k] ? "" : "off"}`;
        span.textContent = k;
        span.onclick = ()=>{ activeCats[k] = !activeCats[k]; span.classList.toggle('off', !activeCats[k]); renderChart(); };
        row.appendChild(span);
      });
    } else {
      [{k:"d1",label:"10â€“25 yd"},{k:"d2",label:"30â€“45 yd"},{k:"d3",label:"50â€“65 yd"}].forEach(({k,label})=>{
        const span = document.createElement('span');
        span.className = `flt flt-${k} ${activeCats[k] ? "" : "off"}`;
        span.textContent = label;
        span.onclick = ()=>{ activeCats[k] = !activeCats[k]; span.classList.toggle('off', !activeCats[k]); renderChart(); };
        row.appendChild(span);
      });
    }
  }

  function bucketForDistance(d){
    d = Number(d)||0;
    if (d>=10 && d<=25) return 'd1';
    if (d>=30 && d<=45) return 'd2';
    if (d>=50 && d<=65) return 'd3';
    return 'd1';
  }
  function colorFor(row){
    if (colorMode === 'lie'){
      switch((row.lie||"").toLowerCase()){
        case "fairway":  return "#7CFC00";
        case "rough":    return "#ffa74d";
        case "sand":     return "#e8d27c";
        case "recovery": return "#ff5a5a";
        default:         return "#e8ecf1";
      }
    } else {
      const b = bucketForDistance(row.dist);
      return (b==='d1') ? "#9cdcfe" : (b==='d2') ? "#a6e22e" : "#ffb454";
    }
  }

  function renderChart(){
    const cv = document.getElementById('chipChart'); if (!cv) return;
    const ctx = cv.getContext('2d'); const W=cv.width, H=cv.height;
    ctx.clearRect(0,0,W,H);

    const pts = saved.filter(r=>{
      if (colorMode === "lie") return activeCats[r.lie ?? ""] === true;
      const b = bucketForDistance(r.dist);
      return activeCats[b] === true;
    }).map(r => ({x:r.chipX, y:r.chipY, c:colorFor(r)}));

    const maxAbs = Math.max(5, ...pts.map(p => Math.max(Math.abs(p.x), Math.abs(p.y))), 5);
    const pad = 10, scale = (Math.min(W,H)/2 - pad) / (maxAbs || 5);
    const cx=W/2, cy=H/2;

    ctx.strokeStyle = '#2a3138'; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(0,cy); ctx.lineTo(W,cy); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(cx,0); ctx.lineTo(cx,H); ctx.stroke();

    ctx.fillStyle = '#9aa7b2'; ctx.font='11px system-ui';
    for (let t=-maxAbs; t<=maxAbs; t+=5){
      const x = cx + t*scale, y = cy - t*scale;
      ctx.strokeStyle='#2a3138';
      ctx.beginPath(); ctx.moveTo(x,cy-3); ctx.lineTo(x,cy+3); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(cx-3,y); ctx.lineTo(cx+3,y); ctx.stroke();
      if (t!==0){ ctx.fillText(String(t), x-6, cy+14); ctx.fillText(String(t), cx+6, y+3); }
    }

    let mx=0,my=0,r=0;
    if (pts.length){
      mx = pts.reduce((s,p)=>s+p.x,0)/pts.length;
      my = pts.reduce((s,p)=>s+p.y,0)/pts.length;
      r  = Math.sqrt(pts.reduce((s,p)=>s+(p.x-mx)*(p.x-mx)+(p.y-my)*(p.y-my),0)/pts.length);
    }
    ctx.strokeStyle='#2ea043'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.arc(cx + mx*scale, cy - my*scale, r*scale, 0, Math.PI*2); ctx.stroke();
    ctx.fillStyle='#2ea043'; ctx.beginPath(); ctx.arc(cx + mx*scale, cy - my*scale, 3, 0, Math.PI*2); ctx.fill();

    pts.forEach(p=>{
      ctx.beginPath(); ctx.arc(cx + p.x*scale, cy - p.y*scale, 2.8, 0, Math.PI*2);
      ctx.fillStyle=p.c; ctx.fill(); ctx.lineWidth=.8; ctx.strokeStyle='rgba(255,255,255,.9)'; ctx.stroke();
    });
  }

  // init
  document.querySelectorAll("#lieChips .pill").forEach(x=>x.classList.remove("active"));
  document.getElementById("chipSection").classList.add("hidden");
  document.getElementById("sectionP1").classList.add("hidden");
  document.getElementById("sectionP23").classList.add("hidden");
  updateChipStepperUI(); updateP1StepperUI();
  renderFilterRow(); calcAll(); renderLog();
</script>
</body>
</html>